<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>vote.rizz - WHO HAS THE MOST RIZZ?!</title>

<!-- Firebase SDK (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

<!-- Face Detection -->
<script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Comic Neue', 'Comic Sans MS', cursive;
    background: linear-gradient(135deg, #0f0024, #1a0033, #0d001a);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== ANIMATED BACKGROUND ===== */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background:
      radial-gradient(circle at 20% 80%, rgba(255,0,255,0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(0,255,255,0.15) 0%, transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(255,255,0,0.08) 0%, transparent 50%);
    z-index: -1;
    animation: bgPulse 4s ease-in-out infinite alternate;
  }

  @keyframes bgPulse {
    0% { opacity: 0.7; }
    100% { opacity: 1; }
  }

  /* ===== FLOATING EMOJIS ===== */
  .floating-emojis {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }

  .floating-emoji {
    position: absolute;
    font-size: 2rem;
    animation: floatUp linear infinite;
    opacity: 0.3;
  }

  @keyframes floatUp {
    0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
    10% { opacity: 0.3; }
    90% { opacity: 0.3; }
    100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
  }

  /* ===== NAVBAR ===== */
  .navbar {
    background: linear-gradient(90deg, #ff00ff, #00ffff, #ff00ff);
    background-size: 200% 100%;
    animation: rainbowSlide 3s linear infinite;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 30px rgba(255,0,255,0.5);
  }

  @keyframes rainbowSlide {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  .navbar .logo {
    font-family: 'Bangers', cursive;
    font-size: 2.2rem;
    color: #0f0024;
    text-shadow: 2px 2px 0 #fff, -1px -1px 0 #ff0;
    cursor: pointer;
    letter-spacing: 2px;
  }

  .navbar .nav-links {
    display: flex;
    gap: 8px;
  }

  .navbar .nav-links button {
    background: rgba(0,0,0,0.3);
    color: #fff;
    border: 2px solid #fff;
    padding: 8px 16px;
    border-radius: 25px;
    font-family: 'Comic Neue', cursive;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .navbar .nav-links button:hover,
  .navbar .nav-links button.active {
    background: #fff;
    color: #0f0024;
    transform: scale(1.1);
    box-shadow: 0 0 15px #fff;
  }

  .navbar .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    color: #0f0024;
    font-size: 1.1rem;
  }

  .navbar .logout-btn {
    background: rgba(255,0,0,0.7);
    color: #fff;
    border: none;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.9rem;
  }

  .navbar .logout-btn:hover {
    background: red;
    transform: scale(1.1);
  }

  /* ===== MAIN CONTAINER ===== */
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 30px 20px;
    position: relative;
    z-index: 1;
  }

  /* ===== AUTH SCREEN ===== */
  .auth-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    text-align: center;
  }

  .auth-screen .big-title {
    font-family: 'Bangers', cursive;
    font-size: 5rem;
    background: linear-gradient(45deg, #ff00ff, #00ffff, #ff0, #ff00ff);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientText 2s ease infinite;
    margin-bottom: 10px;
    text-shadow: none;
    filter: drop-shadow(0 0 20px rgba(255,0,255,0.5));
  }

  @keyframes gradientText {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .auth-screen .subtitle {
    font-size: 1.5rem;
    color: #ff0;
    margin-bottom: 30px;
    animation: bounce 1s ease infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .auth-box {
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(10px);
    border: 3px solid rgba(255,0,255,0.5);
    border-radius: 25px;
    padding: 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 0 40px rgba(255,0,255,0.2), inset 0 0 40px rgba(0,255,255,0.05);
  }

  .auth-box h2 {
    font-family: 'Bangers', cursive;
    font-size: 2rem;
    margin-bottom: 20px;
    color: #0ff;
    text-shadow: 0 0 10px #0ff;
  }

  .auth-box input {
    width: 100%;
    padding: 14px 18px;
    margin-bottom: 15px;
    border: 3px solid #ff00ff;
    border-radius: 15px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1.1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    transition: all 0.3s;
  }

  .auth-box input:focus {
    border-color: #0ff;
    box-shadow: 0 0 20px rgba(0,255,255,0.4);
  }

  .auth-box input::placeholder {
    color: rgba(255,255,255,0.4);
  }

  .btn-primary {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 15px;
    font-family: 'Bangers', cursive;
    font-size: 1.5rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s;
    background: linear-gradient(45deg, #ff00ff, #ff0080);
    color: #fff;
    box-shadow: 0 0 20px rgba(255,0,255,0.4);
  }

  .btn-primary:hover {
    transform: scale(1.05);
    box-shadow: 0 0 40px rgba(255,0,255,0.7);
  }

  .auth-toggle {
    margin-top: 15px;
    color: #aaa;
    font-size: 1rem;
  }

  .auth-toggle span {
    color: #0ff;
    cursor: pointer;
    font-weight: 700;
    text-decoration: underline;
  }

  .auth-toggle span:hover {
    color: #ff0;
  }

  .auth-error {
    color: #ff4444;
    margin-bottom: 10px;
    font-weight: 700;
    min-height: 1.2em;
  }

  /* ===== PAGE TITLE ===== */
  .page-title {
    font-family: 'Bangers', cursive;
    font-size: 3rem;
    text-align: center;
    margin-bottom: 25px;
    text-shadow: 0 0 20px currentColor;
  }

  /* ===== VIDEO CARD ===== */
  .video-card {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,0,255,0.3);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 25px;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .video-card:hover {
    border-color: #0ff;
    box-shadow: 0 0 30px rgba(0,255,255,0.2);
    transform: translateY(-3px);
  }

  .video-card .video-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .video-card .video-title {
    font-family: 'Bangers', cursive;
    font-size: 1.6rem;
    color: #ff0;
    text-shadow: 0 0 8px rgba(255,255,0,0.4);
    flex: 1;
  }

  .video-card .post-actions {
    display: flex;
    gap: 8px;
    margin-left: 10px;
  }

  .video-card .post-actions button {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #aaa;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .video-card .post-actions button:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }

  .video-card .post-actions .delete-btn:hover {
    background: rgba(255,0,0,0.3);
    border-color: #ff4444;
    color: #ff4444;
  }

  .comment-item .comment-actions {
    display: flex;
    gap: 6px;
    margin-left: 8px;
  }

  .comment-item .comment-actions button {
    background: none;
    border: none;
    color: #666;
    font-size: 0.75rem;
    cursor: pointer;
    padding: 2px 4px;
    transition: color 0.2s;
  }

  .comment-item .comment-actions button:hover {
    color: #fff;
  }

  .comment-item .comment-actions .delete-btn:hover {
    color: #ff4444;
  }

  .video-card .video-author {
    color: #0ff;
    font-weight: 700;
    font-size: 0.95rem;
  }

  .video-card .video-embed {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .video-card .video-embed iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
  }

  .video-card .video-embed .video-link {
    color: #0ff;
    font-size: 1.1rem;
    text-decoration: underline;
    word-break: break-all;
  }

  .video-card .video-stats {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 12px;
    font-size: 1.1rem;
  }

  .video-card .avg-rating {
    background: linear-gradient(45deg, #ff0080, #ff00ff);
    padding: 4px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .video-card .vote-count {
    color: #aaa;
    font-size: 0.95rem;
  }

  /* ===== COOL SCALE ===== */
  .cool-scale {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .cool-scale-label {
    font-weight: 700;
    color: #ff0;
    margin-right: 5px;
    font-size: 1rem;
  }

  .cool-scale button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Comic Neue', cursive;
  }

  .cool-scale button:hover {
    background: #ff00ff;
    border-color: #ff00ff;
    transform: scale(1.2);
    box-shadow: 0 0 15px #ff00ff;
  }

  .cool-scale button.selected {
    background: linear-gradient(45deg, #ff00ff, #0ff);
    border-color: #fff;
    transform: scale(1.15);
    box-shadow: 0 0 15px rgba(255,0,255,0.6);
  }

  .cool-scale .already-voted {
    color: #0f0;
    font-weight: 700;
    font-size: 0.95rem;
  }

  /* ===== POST FORM ===== */
  .post-form {
    background: rgba(255,255,255,0.06);
    border: 3px solid rgba(0,255,255,0.4);
    border-radius: 25px;
    padding: 35px;
    max-width: 550px;
    margin: 0 auto;
    box-shadow: 0 0 40px rgba(0,255,255,0.15);
  }

  .post-form input {
    width: 100%;
    padding: 14px 18px;
    margin-bottom: 18px;
    border: 3px solid #ff00ff;
    border-radius: 15px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1.1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .post-form input:focus {
    border-color: #0ff;
    box-shadow: 0 0 20px rgba(0,255,255,0.4);
  }

  .post-form input::placeholder {
    color: rgba(255,255,255,0.4);
  }

  .post-form .hint {
    color: #aaa;
    font-size: 0.9rem;
    margin-bottom: 18px;
    margin-top: -10px;
  }

  .post-form .or-divider {
    text-align: center;
    color: #aaa;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 18px;
    position: relative;
  }

  .post-form .or-divider::before,
  .post-form .or-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 35%;
    height: 1px;
    background: rgba(255,255,255,0.2);
  }

  .post-form .or-divider::before { left: 0; }
  .post-form .or-divider::after { right: 0; }

  .file-upload-wrapper {
    position: relative;
    margin-bottom: 18px;
  }

  .file-upload-btn {
    width: 100%;
    padding: 18px;
    border: 3px dashed rgba(0,255,255,0.5);
    border-radius: 15px;
    background: rgba(0,255,255,0.05);
    color: #0ff;
    font-size: 1.1rem;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
  }

  .file-upload-btn:hover {
    border-color: #0ff;
    background: rgba(0,255,255,0.1);
    box-shadow: 0 0 20px rgba(0,255,255,0.3);
  }

  .file-upload-btn.has-file {
    border-color: #0f0;
    color: #0f0;
    background: rgba(0,255,0,0.05);
  }

  .file-upload-wrapper input[type="file"] {
    display: none;
  }

  .upload-progress {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    margin-top: 10px;
    overflow: hidden;
    display: none;
  }

  .upload-progress .progress-bar {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, #ff00ff, #0ff);
    width: 0%;
    transition: width 0.3s;
  }

  .video-card .video-embed img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
  }

  .video-card .video-embed video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 12px;
    background: #000;
  }

  .post-success {
    color: #0f0;
    font-weight: 700;
    text-align: center;
    margin-top: 15px;
    font-size: 1.2rem;
    min-height: 1.4em;
  }

  /* ===== LEADERBOARD ===== */
  .leaderboard-list {
    list-style: none;
  }

  .leaderboard-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 18px 20px;
    margin-bottom: 12px;
    border-radius: 18px;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.1);
    transition: all 0.3s;
  }

  .leaderboard-item:hover {
    transform: translateX(5px);
    border-color: rgba(255,0,255,0.4);
  }

  .leaderboard-item.rank-1 {
    background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.15));
    border: 3px solid gold;
    box-shadow: 0 0 30px rgba(255,215,0,0.3);
    padding: 22px 20px;
  }

  .leaderboard-item.rank-2 {
    background: linear-gradient(135deg, rgba(192,192,192,0.15), rgba(150,150,150,0.1));
    border-color: silver;
  }

  .leaderboard-item.rank-3 {
    background: linear-gradient(135deg, rgba(205,127,50,0.15), rgba(180,100,30,0.1));
    border-color: #cd7f32;
  }

  .leaderboard-rank {
    font-family: 'Bangers', cursive;
    font-size: 2rem;
    min-width: 50px;
    text-align: center;
  }

  .rank-1 .leaderboard-rank {
    font-size: 2.5rem;
    color: gold;
    text-shadow: 0 0 15px rgba(255,215,0,0.6);
  }

  .rank-2 .leaderboard-rank { color: silver; }
  .rank-3 .leaderboard-rank { color: #cd7f32; }

  .leaderboard-info {
    flex: 1;
  }

  .leaderboard-username {
    font-family: 'Bangers', cursive;
    font-size: 1.5rem;
    color: #fff;
    letter-spacing: 1px;
  }

  .rank-1 .leaderboard-username {
    color: gold;
    font-size: 1.8rem;
  }

  .leaderboard-details {
    color: #aaa;
    font-size: 0.9rem;
  }

  .leaderboard-score {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: #ff00ff;
    text-shadow: 0 0 10px rgba(255,0,255,0.5);
  }

  .rizz-king-badge {
    display: inline-block;
    animation: crownBounce 0.6s ease infinite alternate;
    font-size: 2rem;
    margin-left: 5px;
  }

  @keyframes crownBounce {
    0% { transform: translateY(0) rotate(-5deg); }
    100% { transform: translateY(-6px) rotate(5deg); }
  }

  .rizz-king-label {
    font-family: 'Bangers', cursive;
    background: linear-gradient(45deg, gold, #ff8c00, gold);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientText 1.5s ease infinite;
    font-size: 1rem;
    letter-spacing: 2px;
  }

  .leaderboard-empty {
    text-align: center;
    color: #aaa;
    font-size: 1.2rem;
    padding: 40px;
  }

  /* ===== PROFILE ===== */
  .profile-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .profile-avatar {
    font-size: 5rem;
    margin-bottom: 10px;
    animation: bounce 2s ease infinite;
  }

  .profile-username {
    font-family: 'Bangers', cursive;
    font-size: 2.5rem;
    color: #0ff;
    text-shadow: 0 0 15px rgba(0,255,255,0.5);
  }

  .profile-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 15px;
  }

  .profile-stat {
    text-align: center;
  }

  .profile-stat .stat-num {
    font-family: 'Bangers', cursive;
    font-size: 2.5rem;
    color: #ff00ff;
    text-shadow: 0 0 10px rgba(255,0,255,0.5);
  }

  .profile-stat .stat-label {
    color: #aaa;
    font-size: 0.9rem;
  }

  .profile-videos-title {
    font-family: 'Bangers', cursive;
    font-size: 2rem;
    color: #ff0;
    margin-bottom: 15px;
    text-shadow: 0 0 10px rgba(255,255,0,0.4);
  }

  .no-videos {
    text-align: center;
    color: #aaa;
    font-size: 1.1rem;
    padding: 30px;
  }

  /* ===== LOADING STATE ===== */
  .loading-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    text-align: center;
  }

  .loading-screen .loading-spinner {
    font-size: 3rem;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-screen .loading-text {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: #ff00ff;
    text-shadow: 0 0 15px rgba(255,0,255,0.5);
  }

  /* ===== MISC ===== */
  .hidden { display: none !important; }

  .empty-feed {
    text-align: center;
    padding: 60px 20px;
  }

  .empty-feed .big-emoji {
    font-size: 4rem;
    margin-bottom: 15px;
  }

  .empty-feed p {
    color: #aaa;
    font-size: 1.2rem;
  }

  /* ===== SUBSCRIBE BUTTON ===== */
  .subscribe-btn {
    background: linear-gradient(45deg, #ff0080, #ff00ff);
    color: #fff;
    border: none;
    padding: 4px 14px;
    border-radius: 20px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 8px;
  }

  .subscribe-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(255,0,255,0.6);
  }

  .subscribe-btn.subscribed {
    background: rgba(255,255,255,0.15);
    border: 2px solid #0ff;
    color: #0ff;
  }

  .subscribe-btn.subscribed:hover {
    background: rgba(255,0,0,0.3);
    border-color: #ff4444;
    color: #ff4444;
  }

  .subscriber-count {
    color: #aaa;
    font-size: 0.8rem;
    margin-left: 6px;
  }

  /* ===== COMMENTS ===== */
  .comments-section {
    margin-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
  }

  .comments-toggle {
    background: none;
    border: none;
    color: #aaa;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    padding: 4px 0;
    transition: color 0.2s;
  }

  .comments-toggle:hover {
    color: #0ff;
  }

  .comments-list {
    margin-top: 8px;
    max-height: 300px;
    overflow-y: auto;
  }

  .comment-item {
    display: flex;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .comment-item:last-child {
    border-bottom: none;
  }

  .comment-author {
    color: #0ff;
    font-weight: 700;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .comment-text {
    color: #ddd;
    font-size: 0.9rem;
    word-break: break-word;
  }

  .comment-time {
    color: #666;
    font-size: 0.75rem;
    white-space: nowrap;
    margin-left: auto;
  }

  .comment-form {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .comment-form input {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid rgba(255,0,255,0.3);
    border-radius: 20px;
    background: rgba(0,0,0,0.4);
    color: #fff;
    font-size: 0.9rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    transition: border-color 0.3s;
  }

  .comment-form input:focus {
    border-color: #0ff;
  }

  .comment-form input::placeholder {
    color: rgba(255,255,255,0.3);
  }

  .comment-form button {
    background: linear-gradient(45deg, #ff00ff, #0ff);
    border: none;
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .comment-form button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(0,255,255,0.4);
  }

  /* ===== RULES MODAL ===== */
  .rules-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .rules-box {
    background: linear-gradient(135deg, #1a0033, #0f0024);
    border: 3px solid #ff00ff;
    border-radius: 25px;
    padding: 30px;
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 50px rgba(255,0,255,0.4);
  }

  .rules-box h2 {
    font-family: 'Bangers', cursive;
    font-size: 2.2rem;
    color: #ff0;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 0 0 15px rgba(255,255,0,0.5);
  }

  .rules-section {
    margin-bottom: 20px;
  }

  .rules-section h3 {
    font-family: 'Bangers', cursive;
    font-size: 1.3rem;
    color: #0ff;
    margin-bottom: 10px;
    text-shadow: 0 0 10px rgba(0,255,255,0.4);
  }

  .rules-section ul {
    list-style: none;
    padding-left: 0;
  }

  .rules-section li {
    padding: 6px 0;
    color: #ddd;
    font-size: 0.95rem;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .rules-section li::before {
    content: '✓';
    color: #0f0;
    font-weight: bold;
    flex-shrink: 0;
  }

  .rules-warning {
    background: rgba(255,0,0,0.15);
    border: 2px solid #ff4444;
    border-radius: 15px;
    padding: 15px;
    margin-top: 15px;
  }

  .rules-warning h3 {
    color: #ff4444 !important;
    margin-bottom: 8px;
  }

  .rules-warning li::before {
    content: '⚠';
    color: #ff4444;
  }

  .rules-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 20px 0;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
  }

  .rules-checkbox input {
    width: 24px;
    height: 24px;
    cursor: pointer;
  }

  .rules-checkbox label {
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
  }

  .rules-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 15px;
    font-family: 'Bangers', cursive;
    font-size: 1.4rem;
    letter-spacing: 2px;
    cursor: pointer;
    background: linear-gradient(45deg, #ff00ff, #ff0080);
    color: #fff;
    box-shadow: 0 0 20px rgba(255,0,255,0.4);
    transition: all 0.3s;
  }

  .rules-btn:hover:not(:disabled) {
    transform: scale(1.03);
    box-shadow: 0 0 30px rgba(255,0,255,0.6);
  }

  .rules-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ===== RULES PAGE ===== */
  .rules-page-content {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,0,255,0.3);
    border-radius: 25px;
    padding: 30px;
  }

  /* ===== PROFILE SUBS STATS ===== */
  .profile-sub-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 10px;
  }

  .subscribers-list {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,0,255,0.3);
    border-radius: 15px;
    padding: 12px;
    margin-top: 10px;
    max-height: 200px;
    overflow-y: auto;
  }
  .subscribers-list.hidden { display: none; }
  .subscribers-list-title {
    color: #ff00ff;
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 8px;
    text-align: center;
  }
  .subscriber-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.9rem;
  }
  .subscriber-item:hover {
    background: rgba(255,0,255,0.15);
  }
  .no-subscribers {
    color: #888;
    text-align: center;
    font-size: 0.85rem;
    padding: 8px;
  }

  /* ===== ALL PEOPLE SECTION ===== */
  .all-people-section {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 2px solid rgba(255,255,255,0.1);
  }
  .all-people-title {
    text-align: center;
    font-size: 1.3rem;
    font-weight: bold;
    color: #00ffff;
    margin-bottom: 15px;
  }
  .all-people-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
  }
  .all-people-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(0,255,255,0.2);
    border-radius: 15px;
    padding: 12px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  .all-people-card:hover {
    background: rgba(0,255,255,0.1);
    border-color: rgba(0,255,255,0.5);
    transform: scale(1.03);
  }
  .all-people-avatar {
    font-size: 2rem;
    margin-bottom: 4px;
  }
  .all-people-avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  .all-people-name {
    font-size: 0.85rem;
    font-weight: bold;
    color: #fff;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .all-people-stats {
    font-size: 0.7rem;
    color: #888;
    margin-top: 2px;
  }

  /* ===== EDIT MODAL ===== */
  .edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .edit-modal-box {
    background: linear-gradient(135deg, #1a0033, #0f0024);
    border: 3px solid #0ff;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 0 40px rgba(0,255,255,0.3);
  }

  .edit-modal-box h3 {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: #0ff;
    margin-bottom: 20px;
    text-align: center;
  }

  .edit-modal-box input,
  .edit-modal-box textarea {
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 15px;
    border: 2px solid #ff00ff;
    border-radius: 12px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
  }

  .edit-modal-box textarea {
    min-height: 80px;
    resize: vertical;
  }

  .edit-modal-box input:focus,
  .edit-modal-box textarea:focus {
    border-color: #0ff;
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
  }

  .edit-modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .edit-modal-buttons button {
    padding: 10px 24px;
    border-radius: 12px;
    font-family: 'Bangers', cursive;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .edit-modal-buttons .save-btn {
    background: linear-gradient(45deg, #ff00ff, #0ff);
    border: none;
    color: #fff;
  }

  .edit-modal-buttons .save-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(0,255,255,0.5);
  }

  .edit-modal-buttons .cancel-btn {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    color: #aaa;
  }

  .edit-modal-buttons .cancel-btn:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }

  /* ===== SETTINGS MODAL ===== */
  .settings-btn {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(0,255,255,0.4);
    color: #0ff;
    padding: 8px 16px;
    border-radius: 15px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 15px;
  }

  .settings-btn:hover {
    background: rgba(0,255,255,0.15);
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
  }

  /* ===== ADMIN PANEL ===== */
  .admin-panel {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,0,255,0.4);
    border-radius: 20px;
    padding: 20px;
  }

  .admin-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid rgba(255,255,255,0.1);
    padding-bottom: 15px;
  }

  .admin-tabs button {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.2);
    color: #aaa;
    padding: 10px 20px;
    border-radius: 12px;
    font-family: 'Bangers', cursive;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .admin-tabs button:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }

  .admin-tabs button.active {
    background: linear-gradient(45deg, #ff00ff, #0ff);
    border-color: transparent;
    color: #fff;
  }

  .admin-search {
    width: 100%;
    padding: 12px 18px;
    margin-bottom: 20px;
    border: 2px solid rgba(0,255,255,0.4);
    border-radius: 15px;
    background: rgba(0,0,0,0.4);
    color: #fff;
    font-size: 1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
  }

  .admin-search:focus {
    border-color: #0ff;
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
  }

  .admin-list {
    max-height: 500px;
    overflow-y: auto;
  }

  .admin-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    transition: all 0.2s;
  }

  .admin-item:hover {
    border-color: rgba(255,0,255,0.4);
    background: rgba(255,255,255,0.08);
  }

  .admin-item-info {
    flex: 1;
  }

  .admin-item-title {
    color: #fff;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 4px;
  }

  .admin-item-meta {
    color: #888;
    font-size: 0.85rem;
  }

  .admin-item-actions {
    display: flex;
    gap: 8px;
  }

  .admin-item-actions button {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #aaa;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .admin-item-actions button:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }

  .admin-item-actions .ban-btn:hover {
    background: rgba(255,0,0,0.3);
    border-color: #ff4444;
    color: #ff4444;
  }

  .admin-item.banned {
    opacity: 0.6;
    border-color: rgba(255,0,0,0.3);
  }

  /* ===== CLICKABLE USERNAME ===== */
  .clickable-user {
    cursor: pointer;
    transition: all 0.2s;
  }

  .clickable-user:hover {
    text-decoration: underline;
    filter: brightness(1.3);
  }

  /* ===== PROFILE BIO ===== */
  .profile-bio {
    color: #ccc;
    font-size: 1.05rem;
    margin-top: 8px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    word-break: break-word;
  }

  /* ===== EDIT PROFILE BUTTON ===== */
  .edit-profile-btn {
    background: linear-gradient(45deg, #ff00ff, #0ff);
    color: #fff;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 12px;
  }

  .edit-profile-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(0,255,255,0.5);
  }

  /* ===== BACK BUTTON (other user profile) ===== */
  .back-btn {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    color: #aaa;
    padding: 8px 18px;
    border-radius: 20px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 15px;
  }

  .back-btn:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }

  /* ===== PROFILE PHOTO ===== */
  .profile-avatar-img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #ff00ff;
    box-shadow: 0 0 20px rgba(255,0,255,0.4);
    margin-bottom: 10px;
  }

  /* ===== EDIT PROFILE MODAL ===== */
  .edit-profile-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
  }

  .edit-profile-box {
    background: linear-gradient(135deg, #1a0033, #0f0024);
    border: 3px solid #0ff;
    border-radius: 20px;
    padding: 25px;
    max-width: 450px;
    width: 100%;
    box-shadow: 0 0 40px rgba(0,255,255,0.3);
    max-height: 90vh;
    overflow-y: auto;
  }

  .edit-profile-box h3 {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: #0ff;
    margin-bottom: 18px;
    text-align: center;
  }

  .edit-profile-section {
    margin-bottom: 18px;
  }

  .edit-profile-section label {
    display: block;
    font-weight: 700;
    color: #ff0;
    margin-bottom: 8px;
    font-size: 0.95rem;
  }

  /* Emoji picker grid */
  .emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 6px;
  }

  .emoji-grid button {
    font-size: 1.5rem;
    background: rgba(255,255,255,0.08);
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .emoji-grid button:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.15);
  }

  .emoji-grid button.selected {
    border-color: #0ff;
    background: rgba(0,255,255,0.2);
    box-shadow: 0 0 10px rgba(0,255,255,0.4);
  }

  /* Profile photo upload */
  .profile-photo-upload {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }

  .profile-photo-preview {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #ff00ff;
  }

  .profile-photo-btn {
    background: rgba(255,255,255,0.1);
    border: 2px dashed rgba(0,255,255,0.5);
    color: #0ff;
    padding: 8px 16px;
    border-radius: 12px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .profile-photo-btn:hover {
    background: rgba(0,255,255,0.1);
    border-color: #0ff;
  }

  /* Bio input */
  .bio-input {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #ff00ff;
    border-radius: 12px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    resize: none;
    min-height: 60px;
  }

  .bio-input:focus {
    border-color: #0ff;
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
  }

  .bio-char-count {
    text-align: right;
    color: #666;
    font-size: 0.8rem;
    margin-top: 4px;
  }

  /* Color picker swatches */
  .color-swatches {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .color-swatch {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
  }

  .color-swatch:hover {
    transform: scale(1.2);
    box-shadow: 0 0 15px currentColor;
  }

  .color-swatch.selected {
    border-color: #fff;
    transform: scale(1.15);
    box-shadow: 0 0 15px currentColor;
  }

  .edit-profile-save {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 15px;
    font-family: 'Bangers', cursive;
    font-size: 1.3rem;
    cursor: pointer;
    background: linear-gradient(45deg, #ff00ff, #0ff);
    color: #fff;
    box-shadow: 0 0 20px rgba(0,255,255,0.4);
    transition: all 0.2s;
    margin-top: 10px;
  }

  .edit-profile-save:hover {
    transform: scale(1.03);
    box-shadow: 0 0 30px rgba(0,255,255,0.6);
  }

  .edit-profile-cancel {
    width: 100%;
    padding: 10px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 15px;
    font-family: 'Bangers', cursive;
    font-size: 1.1rem;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
    color: #aaa;
    transition: all 0.2s;
    margin-top: 8px;
  }

  .edit-profile-cancel:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }

  /* Small avatar next to usernames */
  .inline-avatar {
    display: inline-block;
    margin-right: 3px;
    vertical-align: middle;
  }

  .inline-avatar-img {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    object-fit: cover;
    vertical-align: middle;
    margin-right: 3px;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 600px) {
    .auth-screen .big-title { font-size: 3rem; }
    .navbar { flex-wrap: wrap; gap: 8px; }
    .navbar .nav-links { flex-wrap: wrap; justify-content: center; }
    .navbar .nav-links button { padding: 6px 12px; font-size: 0.85rem; }
    .page-title { font-size: 2.2rem; }
    .cool-scale button { width: 34px; height: 34px; font-size: 0.85rem; }
    .leaderboard-item { padding: 14px; }
    .emoji-grid { grid-template-columns: repeat(6, 1fr); }
    .edit-profile-box { padding: 18px; }
    .wheel-wrapper { width: 260px; height: 260px; }
    .wheel-canvas { width: 260px; height: 260px; }
  }

  /* ===== SEARCH BAR ===== */
  .search-container {
    position: relative;
    margin-bottom: 20px;
  }

  .search-input {
    width: 100%;
    padding: 14px 20px 14px 45px;
    border: 3px solid rgba(255,0,255,0.4);
    border-radius: 25px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1.1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    transition: all 0.3s;
  }

  .search-input:focus {
    border-color: #0ff;
    box-shadow: 0 0 25px rgba(0,255,255,0.3);
  }

  .search-input::placeholder {
    color: rgba(255,255,255,0.4);
  }

  .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    pointer-events: none;
  }

  .search-results {
    margin-bottom: 20px;
  }

  .search-results-section {
    margin-bottom: 15px;
  }

  .search-results-section h3 {
    font-family: 'Bangers', cursive;
    font-size: 1.3rem;
    color: #0ff;
    margin-bottom: 10px;
  }

  .search-user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    color: #fff;
    font-weight: 700;
  }

  .search-user-item:hover {
    border-color: #ff00ff;
    background: rgba(255,255,255,0.1);
    transform: translateX(5px);
  }

  .search-no-results {
    text-align: center;
    color: #888;
    padding: 30px;
    font-size: 1.1rem;
  }

  /* ===== MESSAGES ===== */
  .messages-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .new-msg-btn {
    background: linear-gradient(45deg, #ff00ff, #ff0080);
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .new-msg-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(255,0,255,0.5);
  }

  .conversation-list {
    list-style: none;
  }

  .conversation-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .conversation-item:hover {
    border-color: #ff00ff;
    background: rgba(255,255,255,0.1);
    transform: translateX(5px);
  }

  .conversation-item.unread {
    border-color: rgba(255,0,255,0.5);
    background: rgba(255,0,255,0.08);
  }

  .convo-avatar {
    font-size: 2rem;
    min-width: 40px;
    text-align: center;
  }

  .convo-avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }

  .convo-info {
    flex: 1;
    min-width: 0;
  }

  .convo-username {
    font-weight: 700;
    color: #0ff;
    font-size: 1.05rem;
  }

  .convo-preview {
    color: #888;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .convo-time {
    color: #666;
    font-size: 0.8rem;
    white-space: nowrap;
  }

  .convo-unread-dot {
    width: 10px;
    height: 10px;
    background: #ff00ff;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 8px #ff00ff;
  }

  .msg-thread-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(255,255,255,0.1);
  }

  .msg-back-btn {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    color: #aaa;
    padding: 6px 14px;
    border-radius: 15px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .msg-back-btn:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }

  .msg-thread-user {
    font-family: 'Bangers', cursive;
    font-size: 1.5rem;
    color: #0ff;
  }

  .msg-thread-messages {
    max-height: 50vh;
    overflow-y: auto;
    padding: 10px 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .msg-bubble {
    max-width: 75%;
    padding: 10px 16px;
    border-radius: 18px;
    font-size: 0.95rem;
    word-break: break-word;
    line-height: 1.4;
  }

  .msg-bubble.sent {
    align-self: flex-end;
    background: linear-gradient(135deg, #ff00ff, #ff0080);
    color: #fff;
    border-bottom-right-radius: 4px;
  }

  .msg-bubble.received {
    align-self: flex-start;
    background: rgba(255,255,255,0.12);
    color: #eee;
    border-bottom-left-radius: 4px;
  }

  .msg-bubble .msg-time {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.5);
    margin-top: 4px;
    display: block;
  }

  .msg-input-area {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid rgba(255,255,255,0.1);
  }

  .msg-input-area input {
    flex: 1;
    padding: 12px 18px;
    border: 2px solid rgba(255,0,255,0.4);
    border-radius: 25px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    transition: border-color 0.3s;
  }

  .msg-input-area input:focus {
    border-color: #0ff;
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
  }

  .msg-input-area button {
    background: linear-gradient(45deg, #ff00ff, #0ff);
    border: none;
    color: #fff;
    padding: 12px 24px;
    border-radius: 25px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .msg-input-area button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(0,255,255,0.4);
  }

  .no-conversations {
    text-align: center;
    color: #888;
    padding: 40px 20px;
    font-size: 1.1rem;
  }

  .nav-unread-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #ff0;
    border-radius: 50%;
    margin-left: 4px;
    box-shadow: 0 0 6px #ff0;
    vertical-align: middle;
  }

  .new-msg-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .new-msg-box {
    background: linear-gradient(135deg, #1a0033, #0f0024);
    border: 3px solid #ff00ff;
    border-radius: 20px;
    padding: 25px;
    max-width: 450px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 40px rgba(255,0,255,0.3);
  }

  .new-msg-box h3 {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: #ff00ff;
    margin-bottom: 15px;
    text-align: center;
  }

  .user-picker-search {
    width: 100%;
    padding: 10px 16px;
    border: 2px solid rgba(0,255,255,0.4);
    border-radius: 15px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    margin-bottom: 12px;
  }

  .user-picker-search:focus {
    border-color: #0ff;
  }

  .user-picker-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .user-picker-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    color: #fff;
    font-weight: 700;
  }

  .user-picker-item:hover {
    background: rgba(255,0,255,0.15);
  }

  .dm-profile-btn {
    background: linear-gradient(45deg, #ff00ff, #ff0080);
    color: #fff;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
    margin-left: 8px;
  }

  .dm-profile-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255,0,255,0.5);
  }

  /* ===== PRIZE WHEEL ===== */
  .wheel-container {
    text-align: center;
    padding: 20px 0;
  }

  .wheel-locked {
    background: rgba(255,255,255,0.06);
    border: 3px solid rgba(255,255,255,0.15);
    border-radius: 25px;
    padding: 40px 30px;
    text-align: center;
  }

  .wheel-locked .lock-icon {
    font-size: 4rem;
    margin-bottom: 15px;
  }

  .wheel-locked h3 {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: #888;
    margin-bottom: 10px;
  }

  .wheel-locked p {
    color: #aaa;
    font-size: 1rem;
    margin-bottom: 8px;
  }

  .streak-display {
    font-family: 'Bangers', cursive;
    font-size: 2.5rem;
    color: #ff00ff;
    text-shadow: 0 0 15px rgba(255,0,255,0.5);
    margin: 15px 0;
  }

  .streak-bar {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 15px 0;
  }

  .streak-day {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    font-weight: 700;
    color: #666;
  }

  .streak-day.filled {
    background: linear-gradient(135deg, #ff00ff, #ff0080);
    border-color: #ff00ff;
    color: #fff;
    box-shadow: 0 0 10px rgba(255,0,255,0.4);
  }

  .wheel-wrapper {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 20px auto;
  }

  .wheel-canvas {
    width: 300px;
    height: 300px;
    border-radius: 50%;
    border: 5px solid gold;
    box-shadow: 0 0 30px rgba(255,215,0,0.4), inset 0 0 20px rgba(0,0,0,0.3);
  }

  .wheel-pointer {
    position: absolute;
    top: -15px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 2rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    z-index: 2;
  }

  .spin-btn {
    background: linear-gradient(45deg, gold, #ff8c00);
    color: #0f0024;
    border: none;
    padding: 14px 40px;
    border-radius: 25px;
    font-family: 'Bangers', cursive;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 20px;
    box-shadow: 0 0 20px rgba(255,215,0,0.4);
    letter-spacing: 2px;
  }

  .spin-btn:hover:not(:disabled) {
    transform: scale(1.08);
    box-shadow: 0 0 40px rgba(255,215,0,0.6);
  }

  .spin-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .wheel-result {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: gold;
    text-shadow: 0 0 15px rgba(255,215,0,0.5);
    margin-top: 20px;
    min-height: 2em;
  }

  .wheel-cooldown {
    color: #888;
    font-size: 0.95rem;
    margin-top: 10px;
  }

  .prize-badge {
    display: inline-block;
    font-size: 0.85rem;
    margin-left: 3px;
    vertical-align: middle;
    animation: badgeGlow 2s ease-in-out infinite alternate;
  }

  @keyframes badgeGlow {
    0% { filter: brightness(0.9); }
    100% { filter: brightness(1.3); }
  }

  .prize-rainbow-name {
    background: linear-gradient(90deg, #ff0000, #ff8800, #ffff00, #00ff00, #0088ff, #8800ff, #ff0000);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: rainbowText 2s linear infinite;
  }

  @keyframes rainbowText {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  .prize-neon-glow {
    text-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 30px #0ff !important;
  }

  /* ===== FEATURE TILES ===== */
  .feature-tiles {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .feature-tile {
    flex: 1;
    min-width: 140px;
    padding: 14px 16px;
    border-radius: 18px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .feature-tile:hover {
    transform: translateY(-3px);
  }

  .feature-tile .tile-icon {
    font-size: 1.8rem;
  }

  .feature-tile .tile-text {
    font-family: 'Bangers', cursive;
    font-size: 1.15rem;
    letter-spacing: 1px;
  }

  .feature-tile .tile-sub {
    font-family: 'Comic Neue', cursive;
    font-size: 0.75rem;
    font-weight: 400;
    opacity: 0.8;
  }

  .tile-messages {
    background: linear-gradient(135deg, rgba(255,0,255,0.2), rgba(255,0,128,0.15));
    border: 2px solid rgba(255,0,255,0.4);
  }

  .tile-messages:hover {
    border-color: #ff00ff;
    box-shadow: 0 0 20px rgba(255,0,255,0.3);
  }

  .tile-wheel {
    background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,140,0,0.12));
    border: 2px solid rgba(255,215,0,0.4);
  }

  .tile-wheel:hover {
    border-color: gold;
    box-shadow: 0 0 20px rgba(255,215,0,0.3);
  }

  .tile-wheel.tile-locked {
    opacity: 0.7;
  }

  .tile-wheel .tile-streak {
    font-family: 'Bangers', cursive;
    font-size: 0.85rem;
    color: gold;
  }

  .section-title {
    font-family: 'Bangers', cursive;
    font-size: 1.4rem;
    color: #0ff;
    margin-bottom: 8px;
    text-shadow: 0 0 10px rgba(0,255,255,0.3);
    letter-spacing: 1px;
  }

  /* ===== REWARD POPUP ===== */
  .reward-popup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.92);
    z-index: 1001;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: rewardFadeIn 0.4s ease;
  }

  @keyframes rewardFadeIn {
    0% { opacity: 0; }
    100% { opacity: 1; }
  }

  .reward-box {
    background: linear-gradient(135deg, #1a0033, #0f0024);
    border: 4px solid gold;
    border-radius: 25px;
    padding: 35px 30px;
    max-width: 420px;
    width: 100%;
    text-align: center;
    box-shadow: 0 0 60px rgba(255,215,0,0.5), 0 0 120px rgba(255,215,0,0.2);
    animation: rewardPop 0.5s ease;
  }

  @keyframes rewardPop {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }

  .reward-box .reward-icon {
    font-size: 4rem;
    margin-bottom: 10px;
    animation: bounce 1s ease infinite;
  }

  .reward-box h2 {
    font-family: 'Bangers', cursive;
    font-size: 2.2rem;
    color: gold;
    text-shadow: 0 0 20px rgba(255,215,0,0.6);
    margin-bottom: 10px;
  }

  .reward-box p {
    color: #ddd;
    font-size: 1.1rem;
    margin-bottom: 8px;
  }

  .reward-box .reward-prize {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    color: #0ff;
    text-shadow: 0 0 15px rgba(0,255,255,0.5);
    margin: 15px 0;
  }

  .reward-claim-btn {
    background: linear-gradient(45deg, gold, #ff8c00);
    color: #0f0024;
    border: none;
    padding: 14px 40px;
    border-radius: 25px;
    font-family: 'Bangers', cursive;
    font-size: 1.4rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 10px;
    box-shadow: 0 0 20px rgba(255,215,0,0.4);
    letter-spacing: 2px;
  }

  .reward-claim-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 0 40px rgba(255,215,0,0.6);
  }

  /* Sub reward banner on leaderboard */
  .sub-reward-banner {
    background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,140,0,0.08));
    border: 2px solid rgba(255,215,0,0.4);
    border-radius: 18px;
    padding: 18px 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .sub-reward-banner .srb-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
  }

  .sub-reward-banner .srb-info {
    flex: 1;
  }

  .sub-reward-banner .srb-title {
    font-family: 'Bangers', cursive;
    font-size: 1.2rem;
    color: gold;
    margin-bottom: 4px;
  }

  .sub-reward-banner .srb-desc {
    color: #aaa;
    font-size: 0.9rem;
  }

  .sub-reward-banner .srb-progress {
    display: flex;
    gap: 5px;
    margin-top: 8px;
  }

  .sub-reward-banner .srb-dot {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid rgba(255,215,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    color: #666;
  }

  .sub-reward-banner .srb-dot.filled {
    background: linear-gradient(135deg, gold, #ff8c00);
    border-color: gold;
    color: #0f0024;
    box-shadow: 0 0 6px rgba(255,215,0,0.4);
  }

  .sub-reward-banner.claimed {
    border-color: rgba(0,255,0,0.3);
    background: linear-gradient(135deg, rgba(0,255,0,0.08), rgba(0,200,0,0.04));
  }

  .sub-reward-banner.claimed .srb-title {
    color: #0f0;
  }

  /* ===== REFERRAL MODAL ===== */
  .referral-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.92);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .referral-box {
    background: linear-gradient(135deg, #1a0033, #0f0024);
    border: 3px solid #0ff;
    border-radius: 25px;
    padding: 30px;
    max-width: 450px;
    width: 100%;
    text-align: center;
    box-shadow: 0 0 50px rgba(0,255,255,0.3);
  }

  .referral-box h2 {
    font-family: 'Bangers', cursive;
    font-size: 2rem;
    color: #0ff;
    text-shadow: 0 0 15px rgba(0,255,255,0.5);
    margin-bottom: 10px;
  }

  .referral-box p {
    color: #ccc;
    font-size: 1.05rem;
    margin-bottom: 20px;
  }

  .referral-choices {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .referral-choice-btn {
    padding: 16px;
    border-radius: 18px;
    font-family: 'Bangers', cursive;
    font-size: 1.3rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
  }

  .referral-choice-btn:hover {
    transform: scale(1.03);
  }

  .referral-choice-btn.alone {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    color: #aaa;
  }

  .referral-choice-btn.alone:hover {
    background: rgba(255,255,255,0.15);
    color: #fff;
    border-color: #fff;
  }

  .referral-choice-btn.friend {
    background: linear-gradient(45deg, #ff00ff, #0ff);
    border: none;
    color: #fff;
    box-shadow: 0 0 20px rgba(255,0,255,0.3);
  }

  .referral-choice-btn.friend:hover {
    box-shadow: 0 0 30px rgba(255,0,255,0.5);
  }

  /* Referral pick user slide */
  .referral-pick-title {
    font-family: 'Bangers', cursive;
    font-size: 1.5rem;
    color: #ff0;
    margin-bottom: 12px;
  }

  .referral-user-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 15px;
  }

  .referral-user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    color: #fff;
    font-weight: 700;
    font-size: 1.05rem;
    margin-bottom: 6px;
  }

  .referral-user-item:hover {
    background: rgba(255,0,255,0.15);
    transform: translateX(5px);
  }

  .referral-search {
    width: 100%;
    padding: 10px 16px;
    border: 2px solid rgba(0,255,255,0.4);
    border-radius: 15px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 1rem;
    font-family: 'Comic Neue', cursive;
    outline: none;
    margin-bottom: 12px;
  }

  .referral-search:focus {
    border-color: #0ff;
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
  }

  .referral-skip {
    background: none;
    border: none;
    color: #666;
    font-family: 'Comic Neue', cursive;
    font-size: 0.9rem;
    cursor: pointer;
    padding: 8px;
    transition: color 0.2s;
  }

  .referral-skip:hover {
    color: #aaa;
  }

  .free-spins-badge {
    display: inline-block;
    background: linear-gradient(45deg, gold, #ff8c00);
    color: #0f0024;
    font-family: 'Bangers', cursive;
    font-size: 0.95rem;
    padding: 3px 10px;
    border-radius: 12px;
    margin-left: 8px;
    vertical-align: middle;
    box-shadow: 0 0 8px rgba(255,215,0,0.4);
  }

  /* ===== ANNOUNCEMENT BANNER ===== */
  .announcement-banner {
    background: linear-gradient(135deg, #ff00ff, #8800ff, #00ffff);
    border-radius: 18px;
    padding: 16px 20px;
    margin-bottom: 18px;
    text-align: center;
    position: relative;
    overflow: hidden;
    animation: announcePulse 3s ease-in-out infinite;
  }
  @keyframes announcePulse {
    0%, 100% { box-shadow: 0 0 15px rgba(255,0,255,0.4); }
    50% { box-shadow: 0 0 30px rgba(255,0,255,0.7), 0 0 60px rgba(0,255,255,0.3); }
  }
  .announcement-banner::before {
    content: '';
    position: absolute;
    top: 0; left: -100%; width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    animation: announceShine 4s ease-in-out infinite;
  }
  @keyframes announceShine {
    0% { left: -100%; }
    100% { left: 100%; }
  }
  .announcement-title {
    font-family: 'Bangers', cursive;
    font-size: 1.5rem;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    margin-bottom: 6px;
    letter-spacing: 2px;
  }
  .announcement-text {
    font-size: 0.95rem;
    color: rgba(255,255,255,0.95);
    line-height: 1.4;
  }
  .announcement-dismiss {
    position: absolute;
    top: 6px;
    right: 10px;
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 1.2rem;
    cursor: pointer;
  }
  .announcement-dismiss:hover { color: #fff; }
  .announcements-area {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 18px;
  }

  /* ===== AD BANNERS ===== */
  .ad-banner {
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(255,0,255,0.25);
    border-radius: 18px;
    padding: 18px;
    margin: 18px 0;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .ad-banner:hover {
    border-color: rgba(255,0,255,0.5);
  }
  .ad-label {
    position: absolute;
    top: 6px;
    right: 10px;
    font-size: 0.6rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .ad-title {
    font-family: 'Bangers', cursive;
    font-size: 1.3rem;
    margin-bottom: 6px;
  }
  .ad-text {
    font-size: 0.85rem;
    color: #ccc;
    margin-bottom: 10px;
  }
  .ad-cta {
    display: inline-block;
    padding: 8px 24px;
    border-radius: 25px;
    font-family: 'Bangers', cursive;
    font-size: 1rem;
    letter-spacing: 1px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .ad-cta:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(255,0,255,0.4);
  }

  /* ===== CONFETTI ANIMATION ===== */
  .confetti-container {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 1002;
    overflow: hidden;
  }
  .confetti-piece {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 2px;
    animation: confettiFall 2.5s ease-out forwards;
  }
  @keyframes confettiFall {
    0% { transform: translateY(50vh) scale(1) rotate(0deg); opacity: 1; }
    100% { transform: translateY(-20vh) translateX(var(--x)) scale(0.3) rotate(720deg); opacity: 0; }
  }

  /* ===== 100-USER GOAL ===== */
  .goal-tracker {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(0,255,255,0.3);
    border-radius: 18px;
    padding: 14px 18px;
    margin-bottom: 15px;
    text-align: center;
  }
  .goal-title {
    font-family: 'Bangers', cursive;
    font-size: 1.2rem;
    color: #00ffff;
    margin-bottom: 8px;
  }
  .goal-bar-bg {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    height: 22px;
    overflow: hidden;
    position: relative;
  }
  .goal-bar-fill {
    height: 100%;
    border-radius: 12px;
    background: linear-gradient(90deg, #00ffff, #ff00ff);
    transition: width 1s ease;
    min-width: 0;
  }
  .goal-bar-text {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    color: #fff;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  }
  .goal-complete {
    color: gold;
    font-family: 'Bangers', cursive;
    font-size: 1.1rem;
    margin-top: 6px;
    animation: bounce 0.6s infinite alternate;
  }

  /* ===== BIRTHDAY BANNER ===== */
  .birthday-banner {
    background: linear-gradient(135deg, #ff69b4, #ff00ff, #8800ff);
    border-radius: 18px;
    padding: 16px;
    margin-bottom: 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
    animation: announcePulse 2s ease-in-out infinite;
  }
  .birthday-title {
    font-family: 'Bangers', cursive;
    font-size: 1.4rem;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
  }
  .birthday-emojis {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 999;
    overflow: hidden;
  }
  .birthday-emoji {
    position: absolute;
    top: -50px;
    font-size: 2rem;
    animation: bdayFall 4s ease-in forwards;
  }
  @keyframes bdayFall {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
  }

  /* ===== BIRTHDAY MODAL ===== */
  .birthday-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
  }
  .birthday-modal.hidden { display: none; }
  .birthday-box {
    background: linear-gradient(180deg, #1a0030 0%, #0f0024 100%);
    border: 3px solid #ff00ff;
    border-radius: 25px;
    padding: 30px;
    max-width: 380px;
    width: 90%;
    text-align: center;
  }
  .birthday-box h2 {
    font-family: 'Bangers', cursive;
    color: #ff00ff;
    font-size: 1.5rem;
    margin-bottom: 10px;
  }
  .birthday-box p {
    color: #ccc;
    font-size: 0.9rem;
    margin-bottom: 15px;
  }
  .birthday-inputs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
  }
  .birthday-inputs select {
    padding: 10px;
    border-radius: 12px;
    border: 2px solid rgba(255,0,255,0.3);
    background: rgba(255,255,255,0.08);
    color: #fff;
    font-family: 'Comic Neue', cursive;
    font-size: 1rem;
  }
  .birthday-submit {
    background: linear-gradient(135deg, #ff00ff, #ff0080);
    color: #fff;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-family: 'Bangers', cursive;
    font-size: 1.1rem;
    cursor: pointer;
    letter-spacing: 1px;
  }
  .birthday-submit:hover { transform: scale(1.05); }

  /* ===== DISPLAY NAME INPUT ===== */
  .auth-display-name {
    margin-bottom: 15px;
  }

  /* ===== LIVESTREAM ===== */
  .live-page-title { color: #ff4444; }
  .live-status {
    text-align: center;
    padding: 20px;
    color: #888;
  }
  .live-stream-card {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,0,0,0.3);
    border-radius: 18px;
    padding: 15px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .live-stream-card:hover {
    border-color: rgba(255,0,0,0.6);
    background: rgba(255,0,0,0.08);
  }
  .live-stream-card .live-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    background: #ff0000;
    border-radius: 50%;
    margin-right: 6px;
    animation: livePulse 1.5s ease-in-out infinite;
  }
  @keyframes livePulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 4px #ff0000; }
    50% { opacity: 0.5; box-shadow: 0 0 12px #ff0000; }
  }
  .live-stream-title {
    font-family: 'Bangers', cursive;
    font-size: 1.1rem;
    color: #fff;
  }
  .live-stream-info {
    color: #888;
    font-size: 0.85rem;
    margin-top: 4px;
  }
  .live-viewer-area {
    background: #000;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 12px;
    position: relative;
    min-height: 200px;
  }
  .live-viewer-area video {
    width: 100%;
    display: block;
  }
  .live-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .live-btn {
    padding: 10px 20px;
    border-radius: 25px;
    border: none;
    font-family: 'Bangers', cursive;
    font-size: 1rem;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .live-btn:hover { transform: scale(1.05); }
  .live-btn-start {
    background: linear-gradient(135deg, #ff0000, #ff4444);
    color: #fff;
  }
  .live-btn-stop {
    background: linear-gradient(135deg, #444, #666);
    color: #fff;
  }
  .live-btn-report {
    background: linear-gradient(135deg, #ff8800, #ff4444);
    color: #fff;
  }
  .live-btn-back {
    background: rgba(255,255,255,0.1);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
  }
  .live-viewer-count {
    color: #ff4444;
    font-weight: bold;
    font-size: 0.9rem;
    text-align: center;
    margin-bottom: 8px;
  }
  .start-stream-form {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,0,0,0.3);
    border-radius: 18px;
    padding: 20px;
    text-align: center;
  }
  .start-stream-form input {
    width: 100%;
    padding: 10px;
    border-radius: 12px;
    border: 2px solid rgba(255,0,0,0.3);
    background: rgba(255,255,255,0.08);
    color: #fff;
    font-family: 'Comic Neue', cursive;
    font-size: 1rem;
    margin-bottom: 12px;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<!-- Floating Emojis Background -->
<div class="floating-emojis" id="floatingEmojis"></div>

<!-- ===== NAVBAR (hidden until logged in) ===== -->
<nav class="navbar hidden" id="navbar">
  <div class="logo" onclick="showPage('feed')">vote.rizz</div>
  <div class="nav-links">
    <button onclick="showPage('feed')" id="nav-feed">Home</button>
    <button onclick="showPage('post')" id="nav-post">Post</button>
    <button onclick="showPage('leaderboard')" id="nav-leaderboard">Leaderboard</button>
    <button onclick="showPage('announcements')" id="nav-announcements">Announcements</button>
    <button onclick="showPage('rules')" id="nav-rules">Rules</button>
    <button onclick="showPage('messages')" id="nav-messages">Messages</button>
    <button onclick="showPage('wheel')" id="nav-wheel">Prize Wheel</button>
    <button onclick="showPage('live')" id="nav-live">🔴 Live</button>
    <button onclick="viewingUser=null;showPage('profile')" id="nav-profile">Profile</button>
    <!-- Admin panel moved to /admin.html -->
  </div>
  <div class="user-info">
    <span id="navUsername"></span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</nav>

<!-- ===== AUTH SCREEN ===== -->
<div class="container" id="authScreen">
  <div class="auth-screen">
    <div class="big-title">vote.rizz</div>
    <div class="subtitle">WHO HAS THE MOST RIZZ?! 😎🔥👑</div>
    <div class="auth-box">
      <h2 id="authTitle">Login</h2>
      <div class="auth-error" id="authError"></div>
      <input type="text" id="authDisplayName" placeholder="Your Real Name" autocomplete="off" maxlength="30" class="hidden auth-display-name">
      <input type="text" id="authUsername" placeholder="Username" autocomplete="off" maxlength="20">
      <input type="password" id="authPassword" placeholder="Password" maxlength="30">
      <input type="number" id="authBirthYear" placeholder="What year were you born?" min="2007" max="2021" class="hidden" style="margin-bottom:15px;">
      <div id="swearsNotice" class="hidden" style="color:#ff0;font-size:0.85rem;margin-bottom:12px;text-align:center;">⚠️ Swearing is allowed, but inappropriate behavior is NOT. Ages 5-18 only.</div>
      <button class="btn-primary" id="authBtn" onclick="handleAuth()">LET'S GO! 🚀</button>
      <div class="auth-toggle">
        <span id="authToggle" onclick="toggleAuthMode()">Don't have an account? Sign Up!</span>
      </div>
    </div>
  </div>
</div>

<!-- ===== LOADING SCREEN (shown while waiting for Firebase data) ===== -->
<div class="container hidden" id="loadingScreen">
  <div class="loading-screen">
    <div class="loading-spinner">🔥</div>
    <div class="loading-text">Loading the vibes...</div>
  </div>
</div>

<!-- ===== FEED PAGE ===== -->
<div class="container hidden" id="feedPage">
  <div class="page-title" style="color: #0ff;">🔥 THE FEED 🔥</div>

  <!-- Main Announcement -->
  <div class="announcement-banner" style="margin-bottom:15px;">
    <div class="announcement-title">POST & SHARE & VOTE 😊</div>
  </div>

  <!-- Birthday Banner (shown if someone has a birthday today) -->
  <div id="birthdayBannerFeed"></div>

  <!-- 100-User Goal Tracker -->
  <div class="goal-tracker" id="goalTracker">
    <div class="goal-title">🎯 GOAL: <span id="goalCount">0</span>/100 USERS</div>
    <div class="goal-bar-bg">
      <div class="goal-bar-fill" id="goalBarFill" style="width:0%"></div>
      <div class="goal-bar-text" id="goalBarText">0%</div>
    </div>
    <div id="goalMessage"></div>
  </div>

  <!-- Feature Tiles -->
  <div class="feature-tiles">
    <div class="feature-tile tile-messages" onclick="showPage('messages')">
      <div class="tile-icon">💬</div>
      <div>
        <div class="tile-text">Messages</div>
        <div class="tile-sub" id="tileMsgSub">Chat with friends</div>
      </div>
    </div>
    <div class="feature-tile tile-wheel" id="tileWheel" onclick="showPage('wheel')">
      <div class="tile-icon">🎡</div>
      <div>
        <div class="tile-text">Rizz Wheel</div>
        <div class="tile-sub tile-streak" id="tileWheelSub">🔒 Locked</div>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="section-title">🔍 SEARCH</div>
  <div class="search-container">
    <span class="search-icon">🔍</span>
    <input type="text" class="search-input" id="feedSearchInput" placeholder="Search users or posts..." oninput="handleFeedSearch()" maxlength="50">
  </div>
  <div id="searchResults" class="search-results hidden"></div>
  <div id="feedList"></div>
</div>

<!-- ===== POST PAGE ===== -->
<div class="container hidden" id="postPage">
  <div class="page-title" style="color: #ff0;">📹 POST A VIDEO 📹</div>
  <div class="post-form">
    <input type="text" id="postTitle" placeholder="Give it a fire title 🔥" maxlength="60">
    <div class="file-upload-wrapper">
      <div class="file-upload-btn" id="fileUploadBtn" onclick="document.getElementById('postFile').click()">
        📁 TAP TO UPLOAD A VIDEO OR PHOTO
      </div>
      <input type="file" id="postFile" accept="image/*,video/*" onchange="handleFileSelect(this)">
      <div class="upload-progress" id="uploadProgress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
    <div class="or-divider">— OR —</div>
    <input type="text" id="postUrl" placeholder="Paste a link (YouTube, TikTok, etc.)">
    <div class="hint">Upload a file from your device or paste a link!</div>
    <button class="btn-primary" id="postBtn" onclick="postVideo()">POST IT! 🎬</button>
    <div class="post-success" id="postSuccess"></div>
  </div>
</div>

<!-- ===== LEADERBOARD PAGE ===== -->
<div class="container hidden" id="leaderboardPage">
  <div class="page-title" style="color: gold;">👑 LEADERBOARD 👑</div>
  <div id="subRewardBanner"></div>
  <ul class="leaderboard-list" id="leaderboardList"></ul>
  <div class="all-people-section">
    <div class="all-people-title">👥 ALL PEOPLE 👥</div>
    <div id="allPeopleList" class="all-people-list"></div>
  </div>
</div>

<!-- ===== LIVE PAGE ===== -->
<div class="container hidden" id="livePage">
  <div class="page-title live-page-title">🔴 LIVE STREAMS 🔴</div>
  <div id="liveContent">
    <!-- Stream list or viewer will be rendered here by JS -->
    <div class="live-status" id="liveStatus">Loading streams...</div>
    <div id="liveStreamList"></div>
    <div class="start-stream-form" id="startStreamForm">
      <h3 style="color:#ff4444;font-family:'Bangers',cursive;margin-bottom:10px;">START A STREAM</h3>
      <p style="color:#aaa;font-size:0.85rem;margin-bottom:12px;">Share your screen + mic with viewers. No face cam!</p>
      <input type="text" id="streamTitleInput" placeholder="Stream title..." maxlength="50">
      <button class="live-btn live-btn-start" onclick="startLiveStream()">🔴 GO LIVE</button>
    </div>
    <div id="liveViewerContainer" class="hidden">
      <div class="live-viewer-count" id="liveViewerCount"></div>
      <div class="live-viewer-area">
        <video id="liveVideo" autoplay playsinline></video>
      </div>
      <div class="live-controls" id="liveControls"></div>
    </div>
  </div>
</div>

<!-- ===== ANNOUNCEMENTS PAGE ===== -->
<div class="container hidden" id="announcementsPage">
  <div class="page-title" style="color: #ff00ff;">📢 ANNOUNCEMENTS 📢</div>
  <div class="announcements-area">
    <div class="announcement-banner">
      <div class="announcement-title">POST & SHARE & VOTE 😊</div>
      <div class="announcement-text">Post your best videos, vote on your friends, and share the site! The more you participate, the higher you climb!</div>
    </div>
    <div class="announcement-banner" style="background: linear-gradient(135deg, #ff8c00, #ff0080, #8800ff);">
      <div class="announcement-title">🤝 REFER 5 FRIENDS = 4 FREE SPINS!</div>
      <div class="announcement-text">Tell your friends about vote.rizz! When 5 people sign up and say YOU told them, you get 4 FREE Prize Wheel spins!</div>
    </div>
    <div class="announcement-banner" style="background: linear-gradient(135deg, #00ff88, #00ffff, #0088ff);">
      <div class="announcement-title">👑 7-DAY RIZZ KING CHALLENGE!</div>
      <div class="announcement-text">Stay #1 on the leaderboard for 7 days in a row to unlock the Prize Wheel! Win Golden Borders, Rainbow Names, and more!</div>
    </div>
    <div class="announcement-banner" style="background: linear-gradient(135deg, #8800ff, #ff00ff, #ff0080);">
      <div class="announcement-title">💬 DMs ARE HERE!</div>
      <div class="announcement-text">Send private messages to your friends! Tap Messages in the menu or hit the Message button on anyone's profile.</div>
    </div>
    <div class="announcement-banner" style="background: linear-gradient(135deg, #ff4444, #ff8800, #ffcc00);">
      <div class="announcement-title">🔍 SEARCH FOR FRIENDS!</div>
      <div class="announcement-text">Use the search bar on the feed to find users and posts! Tap any username to check out their profile.</div>
    </div>
  </div>

</div>

<!-- ===== RULES PAGE ===== -->
<div class="container hidden" id="rulesPage">
  <div class="page-title" style="color: #ff0;">📜 COMMUNITY RULES 📜</div>
  <div class="rules-page-content">
    <div class="rules-section">
      <h3>Be Kind</h3>
      <ul>
        <li>No mean comments or bullying</li>
        <li>No making fun of people</li>
        <li>No spreading rumors or drama</li>
        <li>Treat everyone with respect</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>Keep It Clean</h3>
      <ul>
        <li>No swear words or inappropriate language</li>
        <li>No slurs of any kind</li>
        <li>No inappropriate pictures or videos</li>
        <li>No violent content</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>Stay Safe</h3>
      <ul>
        <li>No pictures showing your face</li>
        <li>No pictures showing your body</li>
        <li>No sharing personal info (phone number, address, school name, last name)</li>
        <li>No asking others for their personal info</li>
        <li>Don't share your password with anyone</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>No Creepy Stuff</h3>
      <ul>
        <li>No flirting or "dating" posts</li>
        <li>No calling people "hot" or commenting on their looks</li>
        <li>No pretending to be someone else</li>
        <li>No fake accounts to mess with people</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>Content Rules</h3>
      <ul>
        <li>Only post things you made or have permission to share</li>
        <li>No spam or posting the same thing over and over</li>
        <li>Keep post titles appropriate</li>
      </ul>
    </div>
    <div class="rules-section rules-warning">
      <h3>What Happens If You Break Rules</h3>
      <ul>
        <li>First time: Warning</li>
        <li>Second time: Post deleted</li>
        <li>Third time: Account banned</li>
      </ul>
    </div>
  </div>
</div>

<!-- ===== RULES MODAL (for signup) ===== -->
<div class="rules-modal hidden" id="rulesModal">
  <div class="rules-box">
    <h2>📜 COMMUNITY RULES 📜</h2>
    <p style="text-align:center;color:#aaa;margin-bottom:20px;">Please read before joining!</p>

    <div class="rules-section">
      <h3>Be Kind</h3>
      <ul>
        <li>No mean comments or bullying</li>
        <li>No making fun of people</li>
        <li>No spreading rumors or drama</li>
        <li>Treat everyone with respect</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>Keep It Clean</h3>
      <ul>
        <li>No swear words or inappropriate language</li>
        <li>No slurs of any kind</li>
        <li>No inappropriate pictures or videos</li>
        <li>No violent content</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>Stay Safe</h3>
      <ul>
        <li>No pictures showing your face</li>
        <li>No pictures showing your body</li>
        <li>No sharing personal info (phone number, address, school name, last name)</li>
        <li>No asking others for their personal info</li>
        <li>Don't share your password with anyone</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>No Creepy Stuff</h3>
      <ul>
        <li>No flirting or "dating" posts</li>
        <li>No calling people "hot" or commenting on their looks</li>
        <li>No pretending to be someone else</li>
        <li>No fake accounts to mess with people</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>Content Rules</h3>
      <ul>
        <li>Only post things you made or have permission to share</li>
        <li>No spam or posting the same thing over and over</li>
        <li>Keep post titles appropriate</li>
      </ul>
    </div>
    <div class="rules-section rules-warning">
      <h3>What Happens If You Break Rules</h3>
      <ul>
        <li>First time: Warning</li>
        <li>Second time: Post deleted</li>
        <li>Third time: Account banned</li>
      </ul>
    </div>

    <div class="rules-checkbox">
      <input type="checkbox" id="rulesAgree" onchange="updateRulesBtn()">
      <label for="rulesAgree">I have read and agree to follow these rules</label>
    </div>

    <button class="rules-btn" id="rulesAcceptBtn" disabled onclick="acceptRules()">I AGREE - LET ME IN! 🚀</button>
  </div>
</div>

<!-- ===== REFERRAL MODAL ===== -->
<div class="referral-modal hidden" id="referralModal">
  <div class="referral-box">
    <!-- Slide 1: How did you find us? -->
    <div id="referralSlide1">
      <h2>HOW DID YOU FIND US?</h2>
      <p>Welcome to vote.rizz! One quick question...</p>
      <div class="referral-choices">
        <button class="referral-choice-btn friend" onclick="showReferralPicker()">A FRIEND TOLD ME! 🤝</button>
        <button class="referral-choice-btn alone" onclick="skipReferral()">I FOUND IT MYSELF 🔍</button>
      </div>
    </div>
    <!-- Slide 2: Pick who told you -->
    <div id="referralSlide2" class="hidden">
      <div class="referral-pick-title">WHO TOLD YOU ABOUT US?</div>
      <p style="color:#aaa;font-size:0.9rem;margin-bottom:12px;">Pick the friend who introduced you!</p>
      <input type="text" class="referral-search" id="referralSearchInput" placeholder="Search for their username..." oninput="filterReferralUsers()">
      <div class="referral-user-list" id="referralUserList"></div>
      <button class="referral-skip" onclick="skipReferral()">Skip - I don't see them</button>
    </div>
  </div>
</div>

<!-- ===== BIRTHDAY MODAL ===== -->
<div class="birthday-modal hidden" id="birthdayModal">
  <div class="birthday-box">
    <h2>🎂 WHEN'S YOUR BIRTHDAY? 🎂</h2>
    <p>We'll celebrate your special day with a surprise!</p>
    <div class="birthday-inputs">
      <select id="bdayMonth">
        <option value="">Month</option>
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      <select id="bdayDay">
        <option value="">Day</option>
      </select>
    </div>
    <button class="birthday-submit" onclick="submitBirthday()">SAVE BIRTHDAY 🎉</button>
  </div>
</div>

<!-- ===== PROFILE PAGE ===== -->
<div class="container hidden" id="profilePage">
  <div class="page-title" style="color: #0ff;">😎 YOUR PROFILE 😎</div>
  <div class="profile-header">
    <div class="profile-avatar">😎</div>
    <div class="profile-username" id="profileUsername"></div>
    <div class="profile-stats">
      <div class="profile-stat">
        <div class="stat-num" id="profileVideos">0</div>
        <div class="stat-label">Videos</div>
      </div>
      <div class="profile-stat">
        <div class="stat-num" id="profileAvgRating">-</div>
        <div class="stat-label">Avg Rating</div>
      </div>
      <div class="profile-stat">
        <div class="stat-num" id="profileTotalVotes">0</div>
        <div class="stat-label">Total Votes</div>
      </div>
    </div>
    <div class="profile-sub-stats">
      <div class="profile-stat" style="cursor:pointer;" onclick="toggleSubscribersList()">
        <div class="stat-num" id="profileSubscribers">0</div>
        <div class="stat-label">Subscribers ▾</div>
      </div>
      <div class="profile-stat">
        <div class="stat-num" id="profileSubscriptions">0</div>
        <div class="stat-label">Subscribed To</div>
      </div>
    </div>
    <div id="subscribersList" class="subscribers-list hidden"></div>
  </div>
  <button class="settings-btn" onclick="showSettingsModal()">⚙️ Settings</button>
  <div class="profile-videos-title">Your Videos</div>
  <div id="profileVideosList"></div>
</div>

<!-- ===== MESSAGES PAGE ===== -->
<div class="container hidden" id="messagesPage">
  <div class="page-title" style="color: #ff00ff;">💬 MESSAGES 💬</div>
  <div id="messagesContent">
    <div class="messages-header">
      <span></span>
      <button class="new-msg-btn" onclick="openNewMessageModal()">+ New Message</button>
    </div>
    <div id="conversationList" class="conversation-list"></div>
  </div>
  <div id="messageThread" class="hidden">
    <div class="msg-thread-header">
      <button class="msg-back-btn" onclick="backToConversations()">← Back</button>
      <div class="msg-thread-user" id="threadUsername"></div>
    </div>
    <div class="msg-thread-messages" id="threadMessages"></div>
    <div class="msg-input-area">
      <input type="text" id="msgInput" placeholder="Type a message..." maxlength="500" onkeydown="if(event.key==='Enter')sendMessage()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<!-- ===== PRIZE WHEEL PAGE ===== -->
<div class="container hidden" id="wheelPage">
  <div class="page-title" style="color: gold;">🎡 PRIZE WHEEL 🎡</div>
  <div class="wheel-container" id="wheelContent"></div>
</div>

<!-- ===== NEW MESSAGE MODAL ===== -->
<div class="new-msg-modal hidden" id="newMsgModal">
  <div class="new-msg-box">
    <h3>New Message</h3>
    <input type="text" class="user-picker-search" id="userPickerSearch" placeholder="Search for a user..." oninput="filterUserPicker()">
    <div class="user-picker-list" id="userPickerList"></div>
    <button class="edit-profile-cancel" onclick="closeNewMessageModal()" style="margin-top:12px;">Cancel</button>
  </div>
</div>

<!-- Admin panel is at /admin.html -->

<!-- ===== EDIT MODAL ===== -->
<div class="edit-modal hidden" id="editModal">
  <div class="edit-modal-box">
    <h3 id="editModalTitle">Edit</h3>
    <input type="text" id="editModalInput" placeholder="Enter new value...">
    <div class="edit-modal-buttons">
      <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
      <button class="save-btn" onclick="saveEditModal()">Save</button>
    </div>
  </div>
</div>

<!-- ===== EDIT PROFILE MODAL ===== -->
<div class="edit-profile-modal hidden" id="editProfileModal">
  <div class="edit-profile-box">
    <h3>Edit Profile</h3>

    <div class="edit-profile-section">
      <label>Profile Photo</label>
      <div class="profile-photo-upload">
        <img id="editProfilePhotoPreview" class="profile-photo-preview" src="" style="display:none;">
        <span id="editProfileEmojiPreview" style="font-size:2.5rem;">😎</span>
        <button class="profile-photo-btn" onclick="document.getElementById('profilePhotoFile').click()">Upload Photo</button>
        <button class="profile-photo-btn" onclick="clearProfilePhoto()" style="border-color:rgba(255,0,0,0.4);color:#ff6666;">Remove</button>
        <input type="file" id="profilePhotoFile" accept="image/*" style="display:none;" onchange="handleProfilePhotoSelect(this)">
      </div>
    </div>

    <div class="edit-profile-section">
      <label>Emoji Avatar (used if no photo)</label>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>

    <div class="edit-profile-section">
      <label>Bio</label>
      <textarea class="bio-input" id="editBioInput" placeholder="Tell people about yourself..." maxlength="100" oninput="updateBioCount()"></textarea>
      <div class="bio-char-count"><span id="bioCharCount">0</span>/100</div>
    </div>

    <div class="edit-profile-section">
      <label>Profile Color</label>
      <div class="color-swatches" id="colorSwatches"></div>
    </div>

    <button class="edit-profile-save" onclick="saveProfile()">SAVE PROFILE</button>
    <button class="edit-profile-cancel" onclick="closeEditProfileModal()">Cancel</button>
  </div>
</div>

<!-- ===== SETTINGS MODAL ===== -->
<div class="edit-modal hidden" id="settingsModal">
  <div class="edit-modal-box">
    <h3>⚙️ Settings</h3>
    <p style="color:#aaa;margin-bottom:15px;text-align:center;">Change your username</p>
    <input type="text" id="newUsernameInput" placeholder="New username..." maxlength="20">
    <p style="color:#888;font-size:0.85rem;margin-bottom:15px;">This will update your username on all your posts and comments.</p>
    <div class="edit-modal-buttons">
      <button class="cancel-btn" onclick="closeSettingsModal()">Cancel</button>
      <button class="save-btn" onclick="changeUsername()">Change Username</button>
    </div>
  </div>
</div>

<script>
  // ==========================================================
  // ===== FIREBASE CONFIG ====================================
  // ==========================================================
  // 1. Go to https://console.firebase.google.com
  // 2. Create a project (free Spark plan works!)
  // 3. Add a Web app -> copy the config values below
  // 4. Go to Realtime Database -> Create database -> Start in TEST MODE
  // 5. Paste YOUR values below replacing the "YOUR_..." placeholders
  // ==========================================================
  const firebaseConfig = {
    apiKey:            "AIzaSyAZlg0vR2mp3Svsy78QM47XXLZFEt0FbH8",
    authDomain:        "voterizz.firebaseapp.com",
    databaseURL:       "https://voterizz-default-rtdb.firebaseio.com",
    projectId:         "voterizz",
    storageBucket:     "voterizz.firebasestorage.app",
    messagingSenderId: "552652151540",
    appId:             "1:552652151540:web:8f88715ce1855c3f0edca1"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // ===== LOCAL SESSION (just the username string) =====
  function getCurrentUser() {
    return localStorage.getItem('vrizz_current_user');
  }
  function setCurrentUser(username) {
    localStorage.setItem('vrizz_current_user', username);
  }
  function clearCurrentUser() {
    localStorage.removeItem('vrizz_current_user');
  }

  // ===== CACHED FIREBASE DATA =====
  // The real-time listener keeps this up to date
  let cachedVideos = [];   // Array of video objects (converted from Firebase map)
  let videosLoaded = false;
  let videosListener = null;

  // Subscriptions: { username: { targetUser: true, ... } }
  let cachedSubscriptions = {};
  let subsListener = null;
  // Track which comment sections are expanded
  let expandedComments = {};

  // Users + banned caches (referenced in logout)
  let cachedUsers = {};
  let usersListener = null;
  let cachedBanned = {};
  let bannedListener = null;

  // ===== PROFILE CUSTOMIZATION STATE =====
  let viewingUser = null; // null = viewing own profile; string = viewing another user
  let avatarCache = {};   // { username: { avatar: '😎', profilePhoto: 'url', profileColor: '#ff00ff' } }
  let pendingProfilePhoto = null; // File object for new profile photo upload

  // ===== MESSAGING STATE =====
  let cachedConversations = {};
  let conversationsListener = null;
  let currentThreadConvoId = null;
  let currentThreadUser = null;
  let threadMessagesListener = null;
  let unreadCount = 0;

  // ===== PRIZE WHEEL STATE =====
  let rizzKingHistory = {};
  let rizzKingListener = null;
  let userPrizes = {};
  let userPrizesListener = null;
  let wheelSpinning = false;
  let cachedFreeSpins = {}; // { username: numberOfFreeSpins }
  let freeSpinsListener = null;
  let subRewardClaimed = {}; // { username: true } - tracks who already claimed the 5-referral reward
  let subRewardListener = null;
  let rewardPopupShown = false; // prevent showing popup multiple times per session
  let cachedReferrals = {}; // { referrerUsername: { referredUser: true, ... } }
  let referralsListener = null;

  const WHEEL_PRIZES = [
    { name: 'Golden Border', icon: '✨', key: 'golden-border' },
    { name: 'Rainbow Name', icon: '🌈', key: 'rainbow-name' },
    { name: 'Neon Glow', icon: '💫', key: 'neon-glow' },
    { name: 'Diamond Badge', icon: '💎', key: 'diamond-badge' },
    { name: 'Fire Border', icon: '🔥', key: 'fire-border' },
    { name: 'Lightning Badge', icon: '⚡', key: 'lightning-badge' },
    { name: 'Star Badge', icon: '⭐', key: 'star-badge' },
    { name: 'Crown Upgrade', icon: '👑', key: 'crown-upgrade' }
  ];

  const PROFILE_EMOJIS = [
    '😎','🔥','👑','💎','⚡','🎯','🏆','🤩',
    '🐱','🐶','🐼','🦊','🐸','🦁','🐯','🐻',
    '🌟','🌈','🎨','🎮','🎵','🏀','⚽','🎪',
    '🦄','🐲','🦋','🌸','🍕','🍩','🧁','🎂',
    '🚀','🛸','🌙','☀️','🌊','🍀','💜','❤️'
  ];

  const PROFILE_COLORS = [
    '#00ffff', '#ff00ff', '#ff0080', '#ff8800',
    '#ffff00', '#00ff88', '#8844ff', '#ff4444'
  ];

  // Convert Firebase videos object { id: {…}, id2: {…} } → array
  function firebaseVideosToArray(fbVideos) {
    if (!fbVideos) return [];
    return Object.entries(fbVideos).map(([id, data]) => {
      // Convert votes from { username: rating } map to [{ user, rating }] array
      const votesMap = data.votes || {};
      const votesArray = Object.entries(votesMap).map(([user, rating]) => ({ user, rating }));
      // Convert comments from { commentId: {…} } map to array
      const commentsMap = data.comments || {};
      const commentsArray = Object.entries(commentsMap).map(([cid, c]) => ({
        id: cid,
        author: c.author,
        text: c.text,
        created: c.created
      })).sort((a, b) => a.created - b.created);

      return {
        id: id,
        title: data.title,
        url: data.url,
        type: data.type || 'link',
        author: data.author,
        created: data.created,
        votes: votesArray,
        comments: commentsArray
      };
    });
  }

  // ===== FLOATING EMOJIS =====
  function spawnFloatingEmojis() {
    const emojis = ['👑', '🔥', '😎', '💯', '⚡', '✨', '🏆', '💎', '🎯', '🤩'];
    const container = document.getElementById('floatingEmojis');
    for (let i = 0; i < 15; i++) {
      const el = document.createElement('div');
      el.className = 'floating-emoji';
      el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      el.style.left = Math.random() * 100 + '%';
      el.style.animationDuration = (8 + Math.random() * 12) + 's';
      el.style.animationDelay = (Math.random() * 10) + 's';
      el.style.fontSize = (1.2 + Math.random() * 1.5) + 'rem';
      container.appendChild(el);
    }
  }
  spawnFloatingEmojis();

  // ===== AUTH =====
  let isSignUp = false;
  let pendingSignup = null; // { username, password } for after rules accepted

  function updateRulesBtn() {
    var checkbox = document.getElementById('rulesAgree');
    var btn = document.getElementById('rulesAcceptBtn');
    btn.disabled = !checkbox.checked;
  }

  function acceptRules() {
    if (!pendingSignup) return;
    document.getElementById('rulesModal').classList.add('hidden');

    db.ref('users/' + pendingSignup.username).set({
      password: pendingSignup.password,
      created: Date.now(),
      avatar: '😎',
      bio: '',
      profileColor: '#00ffff',
      profilePhoto: '',
      displayName: pendingSignup.displayName || ''
    }).then(function() {
      setCurrentUser(pendingSignup.username);
      document.getElementById('rulesAgree').checked = false;
      updateRulesBtn();
      // Show referral modal before entering app
      showReferralModal();
    });
  }

  function showReferralModal() {
    document.getElementById('referralSlide1').classList.remove('hidden');
    document.getElementById('referralSlide2').classList.add('hidden');
    document.getElementById('referralModal').classList.remove('hidden');

    // Load all users for the picker
    db.ref('users').once('value').then(function(snap) {
      cachedUsers = snap.val() || {};
    });
  }

  function showReferralPicker() {
    document.getElementById('referralSlide1').classList.add('hidden');
    document.getElementById('referralSlide2').classList.remove('hidden');
    document.getElementById('referralSearchInput').value = '';
    filterReferralUsers();
    document.getElementById('referralSearchInput').focus();
  }

  function filterReferralUsers() {
    var query = document.getElementById('referralSearchInput').value.trim().toLowerCase();
    var currentUser = getCurrentUser();
    var container = document.getElementById('referralUserList');

    var users = Object.keys(cachedUsers).filter(function(u) {
      return u !== currentUser && (!query || u.toLowerCase().includes(query));
    });

    if (users.length === 0) {
      container.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">No users found</div>';
      return;
    }

    preloadAvatars(users.slice(0, 20)).then(function() {
      var el = document.getElementById('referralUserList');
      if (!el) return;
      el.innerHTML = users.slice(0, 20).map(function(u) {
        return '<div class="referral-user-item" onclick="selectReferrer(\'' + escapeHtml(u) + '\')">'
          + getAvatarHtml(u) + ' ' + escapeHtml(u)
          + '</div>';
      }).join('');
    });

    container.innerHTML = users.slice(0, 20).map(function(u) {
      return '<div class="referral-user-item" onclick="selectReferrer(\'' + escapeHtml(u) + '\')">'
        + getAvatarHtml(u) + ' ' + escapeHtml(u)
        + '</div>';
    }).join('');
  }

  function selectReferrer(referrerUsername) {
    var currentUser = getCurrentUser();
    // Record referral in Firebase
    db.ref('referrals/' + referrerUsername + '/' + currentUser).set(true);
    // Auto-subscribe to referrer
    db.ref('subscriptions/' + currentUser + '/' + referrerUsername).set(true);
    finishReferral();
  }

  function skipReferral() {
    finishReferral();
  }

  function finishReferral() {
    document.getElementById('referralModal').classList.add('hidden');
    pendingSignup = null;
    // Show birthday modal for new users
    showBirthdayModal();
  }

  function showBirthdayModal() {
    // Populate day dropdown
    var daySelect = document.getElementById('bdayDay');
    daySelect.innerHTML = '<option value="">Day</option>';
    for (var i = 1; i <= 31; i++) {
      var val = i < 10 ? '0' + i : '' + i;
      daySelect.innerHTML += '<option value="' + val + '">' + i + '</option>';
    }
    document.getElementById('birthdayModal').classList.remove('hidden');
  }

  function submitBirthday() {
    var month = document.getElementById('bdayMonth').value;
    var day = document.getElementById('bdayDay').value;
    if (!month || !day) {
      alert('Please pick your birthday month and day!');
      return;
    }
    var currentUser = getCurrentUser();
    if (currentUser) {
      db.ref('users/' + currentUser + '/birthday').set(month + '-' + day);
    }
    document.getElementById('birthdayModal').classList.add('hidden');
    doEnterApp();
  }

  function toggleAuthMode() {
    isSignUp = !isSignUp;
    document.getElementById('authTitle').textContent = isSignUp ? 'Sign Up' : 'Login';
    document.getElementById('authBtn').textContent = isSignUp ? "LET'S GOOO! 🎉" : "LET'S GO! 🚀";
    document.getElementById('authToggle').textContent = isSignUp
      ? 'Already have an account? Login!'
      : "Don't have an account? Sign Up!";
    document.getElementById('authError').textContent = '';
    document.getElementById('authDisplayName').classList.toggle('hidden', !isSignUp);
    document.getElementById('authBirthYear').classList.toggle('hidden', !isSignUp);
    document.getElementById('swearsNotice').classList.toggle('hidden', !isSignUp);
    if (!isSignUp) {
      document.getElementById('authBirthYear').value = '';
      document.getElementById('authDisplayName').value = '';
    }
  }

  function handleAuth() {
    const username = document.getElementById('authUsername').value.trim().toLowerCase();
    const password = document.getElementById('authPassword').value;
    const errorEl = document.getElementById('authError');
    const authBtn = document.getElementById('authBtn');

    if (!username || !password) {
      errorEl.textContent = 'Bruh fill in both fields!! 😤';
      return;
    }
    if (username.length < 2) {
      errorEl.textContent = 'Username too short fam! 🙄';
      return;
    }

    if (isSignUp) {
      var displayName = document.getElementById('authDisplayName').value.trim();
      if (!displayName || displayName.length < 2) {
        errorEl.textContent = 'Please enter your real name! 🙏';
        return;
      }
      var nameCheck = checkContentModeration(displayName);
      if (!nameCheck.ok) {
        errorEl.textContent = '🚫 That name isn\'t allowed!';
        return;
      }

      var birthYear = parseInt(document.getElementById('authBirthYear').value);
      var currentYear = new Date().getFullYear();
      var age = currentYear - birthYear;
      if (!birthYear || age < 5 || age > 18) {
        errorEl.textContent = 'You gotta be between 5 and 18 to sign up!! 🚫';
        return;
      }
    }

    // Disable button while checking Firebase
    authBtn.disabled = true;
    authBtn.textContent = 'HOLD ON...';

    if (isSignUp) {
      // Check username for inappropriate content
      var usernameCheck = checkContentModeration(username);
      if (!usernameCheck.ok) {
        errorEl.textContent = '🚫 That username isn\'t allowed! Pick something nicer.';
        authBtn.disabled = false;
        authBtn.textContent = "LET'S GOOO! 🎉";
        return;
      }

      db.ref('users/' + username).once('value').then(function(snapshot) {
        if (snapshot.exists()) {
          errorEl.textContent = 'That username is taken bro!! 😬';
          authBtn.disabled = false;
          authBtn.textContent = "LET'S GOOO! 🎉";
          return;
        }
        // Show rules modal before creating account
        pendingSignup = { username: username, password: password, displayName: document.getElementById('authDisplayName').value.trim() };
        document.getElementById('rulesModal').classList.remove('hidden');
        authBtn.disabled = false;
        authBtn.textContent = "LET'S GOOO! 🎉";
      }).catch(function(err) {
        errorEl.textContent = 'Firebase error! Check your config 😵';
        authBtn.disabled = false;
        authBtn.textContent = "LET'S GOOO! 🎉";
        console.error(err);
      });
    } else {
      db.ref('users/' + username).once('value').then(function(snapshot) {
        if (!snapshot.exists()) {
          errorEl.textContent = "No account with that name! 🤔";
          authBtn.disabled = false;
          authBtn.textContent = "LET'S GO! 🚀";
          return;
        }
        if (snapshot.val().password !== password) {
          errorEl.textContent = 'Wrong password!! 🔒';
          authBtn.disabled = false;
          authBtn.textContent = "LET'S GO! 🚀";
          return;
        }
        // Check if banned
        db.ref('banned/' + username).once('value').then(function(banSnap) {
          if (banSnap.exists() && banSnap.val() === true) {
            errorEl.textContent = 'Your account has been banned! 🚫';
            authBtn.disabled = false;
            authBtn.textContent = "LET'S GO! 🚀";
            return;
          }
          setCurrentUser(username);
          authBtn.disabled = false;
          enterApp();
        });
      }).catch(function(err) {
        errorEl.textContent = 'Firebase error! Check your config 😵';
        authBtn.disabled = false;
        authBtn.textContent = "LET'S GO! 🚀";
        console.error(err);
      });
    }
  }

  // Enter on password field
  document.getElementById('authPassword').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') handleAuth();
  });
  document.getElementById('authUsername').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('authPassword').focus();
  });

  function logout() {
    // Detach real-time listeners
    if (videosListener) {
      db.ref('videos').off('value', videosListener);
      videosListener = null;
    }
    if (subsListener) {
      db.ref('subscriptions').off('value', subsListener);
      subsListener = null;
    }
    if (usersListener) {
      db.ref('users').off('value', usersListener);
      usersListener = null;
    }
    if (bannedListener) {
      db.ref('banned').off('value', bannedListener);
      bannedListener = null;
    }
    if (conversationsListener) {
      db.ref('conversations').off('value', conversationsListener);
      conversationsListener = null;
    }
    if (threadMessagesListener) {
      db.ref('messages/' + currentThreadConvoId).off('value', threadMessagesListener);
      threadMessagesListener = null;
    }
    if (rizzKingListener) {
      db.ref('rizzKingHistory').off('value', rizzKingListener);
      rizzKingListener = null;
    }
    if (userPrizesListener) {
      db.ref('userPrizes').off('value', userPrizesListener);
      userPrizesListener = null;
    }
    videosLoaded = false;
    cachedVideos = [];
    cachedSubscriptions = {};
    cachedUsers = {};
    cachedBanned = {};
    expandedComments = {};
    isAdmin = false;
    avatarCache = {};
    viewingUser = null;
    pendingProfilePhoto = null;
    cachedConversations = {};
    currentThreadConvoId = null;
    currentThreadUser = null;
    unreadCount = 0;
    if (freeSpinsListener) {
      db.ref('freeSpins').off('value', freeSpinsListener);
      freeSpinsListener = null;
    }
    if (subRewardListener) {
      db.ref('subRewardClaimed').off('value', subRewardListener);
      subRewardListener = null;
    }
    if (referralsListener) {
      db.ref('referrals').off('value', referralsListener);
      referralsListener = null;
    }
    rizzKingHistory = {};
    userPrizes = {};
    wheelSpinning = false;
    cachedFreeSpins = {};
    subRewardClaimed = {};
    rewardPopupShown = false;
    cachedReferrals = {};

    clearCurrentUser();
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('navbar').classList.add('hidden');
    hideAllPages();
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('authUsername').value = '';
    document.getElementById('authPassword').value = '';
    document.getElementById('authDisplayName').value = '';
    document.getElementById('authError').textContent = '';
    // Stop any active stream
    if (currentStream) stopStream();
    if (livestreamListener) { db.ref('livestreams').off('value', livestreamListener); livestreamListener = null; }
  }

  function enterApp() {
    var currentUser = getCurrentUser();

    // Check if user has a birthday set - if not, ask them first
    db.ref('users/' + currentUser + '/birthday').once('value').then(function(snap) {
      if (!snap.val()) {
        // No birthday set - show birthday modal before entering app
        document.getElementById('authScreen').classList.add('hidden');
        showBirthdayModal();
        return;
      }
      // Birthday already set, continue normally
      doEnterApp();
    }).catch(function() {
      doEnterApp();
    });
  }

  function doEnterApp() {
    var currentUser = getCurrentUser();
    document.getElementById('birthdayModal').classList.add('hidden');
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('navbar').classList.remove('hidden');
    // Load own avatar and set nav
    loadUserProfile(currentUser).then(function() {
      document.getElementById('navUsername').innerHTML = getAvatarHtml(currentUser) + ' ' + escapeHtml(currentUser);
    });
    document.getElementById('navUsername').textContent = currentUser;

    // Check if user is admin
    checkAdminStatus();

    // Load users cache for search
    if (!usersListener) {
      usersListener = db.ref('users').on('value', function(snapshot) {
        cachedUsers = snapshot.val() || {};
      });
    }

    // Check if announcement was dismissed
    checkAnnouncementDismissed();

    // Show loading screen while we wait for the first Firebase snapshot
    if (!videosLoaded) {
      hideAllPages();
      document.getElementById('loadingScreen').classList.remove('hidden');
    }

    // Attach real-time listener for subscriptions
    if (!subsListener) {
      subsListener = db.ref('subscriptions').on('value', function(snapshot) {
        cachedSubscriptions = snapshot.val() || {};
        rerenderCurrentPage();
      });
    }

    // Attach real-time listener for videos
    if (!videosListener) {
      videosListener = db.ref('videos').on('value', function(snapshot) {
        cachedVideos = firebaseVideosToArray(snapshot.val());
        var wasLoaded = videosLoaded;
        videosLoaded = true;

        // If this is the first load, switch from loading screen to feed
        if (!wasLoaded) {
          document.getElementById('loadingScreen').classList.add('hidden');
          showPage('feed');
        } else {
          // Re-render whatever page is currently visible
          rerenderCurrentPage();
        }
      });
    } else {
      showPage('feed');
    }

    // Attach conversations listener for messaging
    startConversationsListener();

    // Attach rizz king history listener
    if (!rizzKingListener) {
      rizzKingListener = db.ref('rizzKingHistory').on('value', function(snapshot) {
        rizzKingHistory = snapshot.val() || {};
      });
    }

    // Attach user prizes listener
    if (!userPrizesListener) {
      userPrizesListener = db.ref('userPrizes').on('value', function(snapshot) {
        userPrizes = snapshot.val() || {};
        rerenderCurrentPage();
      });
    }

    // Attach free spins listener
    if (!freeSpinsListener) {
      freeSpinsListener = db.ref('freeSpins').on('value', function(snapshot) {
        cachedFreeSpins = snapshot.val() || {};
      });
    }

    // Attach sub reward listener
    if (!subRewardListener) {
      subRewardListener = db.ref('subRewardClaimed').on('value', function(snapshot) {
        subRewardClaimed = snapshot.val() || {};
      });
    }

    // Attach referrals listener
    if (!referralsListener) {
      referralsListener = db.ref('referrals').on('value', function(snapshot) {
        cachedReferrals = snapshot.val() || {};
      });
    }

    rewardPopupShown = false;

    // Record today's rizz king
    recordDailyRizzKing();

    // Check if current user is consecutive king (daily reward)
    setTimeout(function() { checkDailyKingReward(); }, 3000);
  }

  // Figure out which page is showing and re-render it
  function rerenderCurrentPage() {
    if (!document.getElementById('feedPage').classList.contains('hidden')) {
      renderFeed();
    } else if (!document.getElementById('leaderboardPage').classList.contains('hidden')) {
      renderLeaderboard();
    } else if (!document.getElementById('profilePage').classList.contains('hidden')) {
      renderProfile();
    } else if (!document.getElementById('wheelPage').classList.contains('hidden')) {
      renderWheel();
    }
  }

  // ===== NAVIGATION =====
  function hideAllPages() {
    ['feedPage', 'postPage', 'leaderboardPage', 'announcementsPage', 'rulesPage', 'profilePage', 'messagesPage', 'wheelPage', 'livePage'].forEach(id => {
      var el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    });
    ['nav-feed', 'nav-post', 'nav-leaderboard', 'nav-announcements', 'nav-rules', 'nav-profile', 'nav-messages', 'nav-wheel', 'nav-live'].forEach(id => {
      var el = document.getElementById(id);
      if (el) el.classList.remove('active');
    });
  }

  function showPage(page) {
    hideAllPages();
    document.getElementById('loadingScreen').classList.add('hidden');
    switch(page) {
      case 'feed':
        document.getElementById('feedPage').classList.remove('hidden');
        document.getElementById('nav-feed').classList.add('active');
        // Clear search when navigating to feed
        var searchInput = document.getElementById('feedSearchInput');
        if (searchInput) searchInput.value = '';
        var searchResults = document.getElementById('searchResults');
        if (searchResults) { searchResults.classList.add('hidden'); searchResults.innerHTML = ''; }
        var feedListEl = document.getElementById('feedList');
        if (feedListEl) feedListEl.style.display = '';
        renderFeed();
        break;
      case 'post':
        document.getElementById('postPage').classList.remove('hidden');
        document.getElementById('nav-post').classList.add('active');
        document.getElementById('postSuccess').textContent = '';
        break;
      case 'leaderboard':
        document.getElementById('leaderboardPage').classList.remove('hidden');
        document.getElementById('nav-leaderboard').classList.add('active');
        renderLeaderboard();
        break;
      case 'announcements':
        document.getElementById('announcementsPage').classList.remove('hidden');
        document.getElementById('nav-announcements').classList.add('active');
        break;
      case 'rules':
        document.getElementById('rulesPage').classList.remove('hidden');
        document.getElementById('nav-rules').classList.add('active');
        break;
      case 'profile':
        document.getElementById('profilePage').classList.remove('hidden');
        document.getElementById('nav-profile').classList.add('active');
        // If coming from nav button (not viewUserProfile), show own profile
        if (!viewingUser) viewingUser = null;
        renderProfile();
        break;
      case 'messages':
        document.getElementById('messagesPage').classList.remove('hidden');
        document.getElementById('nav-messages').classList.add('active');
        showConversationList();
        break;
      case 'wheel':
        document.getElementById('wheelPage').classList.remove('hidden');
        document.getElementById('nav-wheel').classList.add('active');
        renderWheel();
        break;
      case 'live':
        document.getElementById('livePage').classList.remove('hidden');
        document.getElementById('nav-live').classList.add('active');
        renderLivePage();
        break;
    }
  }

  // ===== VIDEO EMBED HELPER =====
  function getEmbedUrl(url) {
    // YouTube
    let m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/);
    if (m) return 'https://www.youtube.com/embed/' + m[1];
    // TikTok
    m = url.match(/tiktok\.com\/@[^/]+\/video\/(\d+)/);
    if (m) return 'https://www.tiktok.com/embed/v2/' + m[1];
    return null;
  }

  function renderVideoEmbed(video) {
    var url = video.url || video;
    var type = video.type || 'link';

    if (type === 'image') {
      return '<img src="' + escapeHtml(url) + '" alt="uploaded photo" loading="lazy">';
    }
    if (type === 'video') {
      return '<video src="' + escapeHtml(url) + '#t=0.5" controls playsinline preload="auto"></video>';
    }
    // type === 'link' — try to embed
    const embedUrl = getEmbedUrl(url);
    if (embedUrl) {
      return '<iframe src="' + embedUrl + '" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>';
    }
    return '<a href="' + escapeHtml(url) + '" target="_blank" class="video-link">🔗 ' + escapeHtml(url) + '</a>';
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ===== FEED =====
  // Build the HTML for a single video card's dynamic parts (everything except embed)
  function buildCardParts(v, currentUser) {
    var avgRating = v.votes.length > 0
      ? (v.votes.reduce(function(sum, vote) { return sum + vote.rating; }, 0) / v.votes.length).toFixed(1)
      : '-';
    var userVote = v.votes.find(function(vote) { return vote.user === currentUser; });
    var isOwnVideo = v.author === currentUser;

    var voteHtml;
    if (isOwnVideo) {
      voteHtml = '<span class="already-voted">Your video!</span>';
    } else if (userVote) {
      voteHtml = '<span class="already-voted">You rated: ' + userVote.rating + '/10 ✅</span>';
    } else {
      voteHtml = '';
      for (var i = 1; i <= 10; i++) {
        voteHtml += '<button onclick="voteVideo(\'' + v.id + '\', ' + i + ')">' + i + '</button>';
      }
    }

    var subBtn = '';
    if (v.author !== currentUser) {
      var isSub = cachedSubscriptions[currentUser] && cachedSubscriptions[currentUser][v.author];
      subBtn = '<button class="subscribe-btn' + (isSub ? ' subscribed' : '') + '" onclick="toggleSubscribe(\'' + escapeHtml(v.author) + '\')">'
        + (isSub ? 'Subscribed' : 'Subscribe')
        + '</button>';
    }
    var subCount = getSubscriberCount(v.author);
    var subCountHtml = subCount > 0 ? '<span class="subscriber-count">' + subCount + ' sub' + (subCount !== 1 ? 's' : '') + '</span>' : '';

    // Post actions (edit/delete for own posts)
    var postActionsHtml = '';
    if (isOwnVideo || isAdmin) {
      postActionsHtml = '<div class="post-actions">'
        + '<button onclick="editPost(\'' + v.id + '\')">✏️ Edit</button>'
        + '<button class="delete-btn" onclick="deletePost(\'' + v.id + '\')">🗑️ Delete</button>'
        + '</div>';
    }

    var commentCount = v.comments.length;
    var isExpanded = expandedComments[v.id];
    var commentsHtml = '<div class="comments-section">'
      + '<button class="comments-toggle" onclick="toggleComments(\'' + v.id + '\')">'
      + '💬 ' + commentCount + ' comment' + (commentCount !== 1 ? 's' : '')
      + (isExpanded ? ' ▲' : ' ▼')
      + '</button>';
    if (isExpanded) {
      commentsHtml += '<div class="comments-list">';
      if (v.comments.length === 0) {
        commentsHtml += '<div style="color:#666;font-size:0.85rem;padding:8px 0;">No comments yet. Be the first!</div>';
      } else {
        v.comments.forEach(function(c) {
          var isOwnComment = c.author === currentUser;
          var commentActionsHtml = '';
          if (isOwnComment || isAdmin) {
            commentActionsHtml = '<div class="comment-actions">'
              + '<button onclick="editComment(\'' + v.id + '\', \'' + c.id + '\')">edit</button>'
              + '<button class="delete-btn" onclick="deleteComment(\'' + v.id + '\', \'' + c.id + '\')">delete</button>'
              + '</div>';
          }
          commentsHtml += '<div class="comment-item">'
            + '<span class="comment-author">' + getClickableUsername(c.author) + ':</span>'
            + '<span class="comment-text">' + escapeHtml(c.text) + '</span>'
            + '<span class="comment-time">' + timeAgo(c.created) + '</span>'
            + commentActionsHtml
            + '</div>';
        });
      }
      commentsHtml += '</div>';
      commentsHtml += '<div class="comment-form">'
        + '<input type="text" id="comment-' + v.id + '" placeholder="Add a comment..." maxlength="200" onkeydown="if(event.key===\'Enter\')postComment(\'' + v.id + '\')">'
        + '<button onclick="postComment(\'' + v.id + '\')">Post</button>'
        + '</div>';
    }
    commentsHtml += '</div>';

    return {
      authorHtml: 'by ' + getClickableUsername(v.author) + subBtn + subCountHtml,
      postActionsHtml: postActionsHtml,
      statsHtml: '<span class="avg-rating">⭐ ' + avgRating + '/10</span>'
        + '<span class="vote-count">' + v.votes.length + ' vote' + (v.votes.length !== 1 ? 's' : '') + '</span>',
      scaleHtml: '<span class="cool-scale-label">COOL SCALE:</span>' + voteHtml,
      commentsHtml: commentsHtml
    };
  }

  function renderFeed() {
    var videos = cachedVideos;
    var container = document.getElementById('feedList');
    var currentUser = getCurrentUser();

    // Update feature tiles
    updateFeatureTiles();
    // Update goal tracker + birthday banner
    updateGoalTracker();
    checkBirthdays();

    if (videos.length === 0) {
      container.innerHTML = '<div class="empty-feed"><div class="big-emoji">😴</div><p>No videos yet!! Be the first to post something cool!</p></div>';
      return;
    }

    var sorted = [].concat(videos).sort(function(a, b) { return b.created - a.created; });

    // Gather all usernames (authors + commenters) for avatar preloading
    var allUsers = {};
    sorted.forEach(function(v) {
      allUsers[v.author] = true;
      (v.comments || []).forEach(function(c) { allUsers[c.author] = true; });
    });
    var userList = Object.keys(allUsers);

    // Preload avatars then render
    preloadAvatars(userList).then(function() {
      doRenderFeed(sorted, container, currentUser);
    });
    // Also render immediately with whatever we have cached
    doRenderFeed(sorted, container, currentUser);
  }

  function doRenderFeed(sorted, container, currentUser) {
    // Check if we can do a smart update (same video IDs in same order)
    var existingCards = container.querySelectorAll('.video-card[data-vid]');
    var existingIds = [];
    for (var i = 0; i < existingCards.length; i++) {
      existingIds.push(existingCards[i].getAttribute('data-vid'));
    }
    var newIds = sorted.map(function(v) { return v.id; });
    var canPatch = existingIds.length === newIds.length && existingIds.every(function(id, idx) { return id === newIds[idx]; });

    if (canPatch) {
      // Smart update — only update dynamic parts, leave video embeds alone
      sorted.forEach(function(v, idx) {
        var card = existingCards[idx];
        var parts = buildCardParts(v, currentUser);
        var titleEl = card.querySelector('.video-title');
        if (titleEl) titleEl.textContent = v.title;
        var authorEl = card.querySelector('.video-author');
        if (authorEl) authorEl.innerHTML = parts.authorHtml;
        var postActionsEl = card.querySelector('.post-actions');
        if (postActionsEl) {
          postActionsEl.outerHTML = parts.postActionsHtml;
        } else if (parts.postActionsHtml) {
          var headerEl = card.querySelector('.video-header');
          if (headerEl) headerEl.insertAdjacentHTML('beforeend', parts.postActionsHtml);
        }
        var statsEl = card.querySelector('.video-stats');
        if (statsEl) statsEl.innerHTML = parts.statsHtml;
        var scaleEl = card.querySelector('.cool-scale');
        if (scaleEl) scaleEl.innerHTML = parts.scaleHtml;
        var commentsEl = card.querySelector('.comments-section');
        if (commentsEl) {
          commentsEl.outerHTML = parts.commentsHtml;
        }
      });
    } else {
      // Full render — videos added/removed/reordered
      container.innerHTML = sorted.map(function(v) {
        var parts = buildCardParts(v, currentUser);
        return '<div class="video-card" data-vid="' + v.id + '">'
          + '<div class="video-header">'
          + '<div class="video-title">' + escapeHtml(v.title) + '</div>'
          + '<div class="video-author">' + parts.authorHtml + '</div>'
          + parts.postActionsHtml
          + '</div>'
          + '<div class="video-embed">' + renderVideoEmbed(v) + '</div>'
          + '<div class="video-stats">' + parts.statsHtml + '</div>'
          + '<div class="cool-scale">' + parts.scaleHtml + '</div>'
          + parts.commentsHtml
          + '</div>';
      }).join('');
    }
  }

  function voteVideo(videoId, rating) {
    const currentUser = getCurrentUser();
    // Write directly to Firebase — the real-time listener will update the UI
    db.ref('videos/' + videoId + '/votes/' + currentUser).set(rating);
  }

  // ===== SUBSCRIBE =====
  function toggleSubscribe(targetUser) {
    var currentUser = getCurrentUser();
    if (!currentUser || currentUser === targetUser) return;
    var ref = db.ref('subscriptions/' + currentUser + '/' + targetUser);
    var isSub = cachedSubscriptions[currentUser] && cachedSubscriptions[currentUser][targetUser];
    if (isSub) {
      ref.remove();
    } else {
      ref.set(true);
    }
  }

  function getSubscriberCount(username) {
    var count = 0;
    Object.keys(cachedSubscriptions).forEach(function(user) {
      if (cachedSubscriptions[user] && cachedSubscriptions[user][username]) {
        count++;
      }
    });
    return count;
  }

  function getSubscribers(username) {
    var subs = [];
    Object.keys(cachedSubscriptions).forEach(function(user) {
      if (cachedSubscriptions[user] && cachedSubscriptions[user][username]) {
        subs.push(user);
      }
    });
    return subs;
  }

  function toggleSubscribersList() {
    var listEl = document.getElementById('subscribersList');
    if (!listEl) return;
    if (listEl.classList.contains('hidden')) {
      var targetUser = viewingUser || getCurrentUser();
      var subs = getSubscribers(targetUser);
      if (subs.length === 0) {
        listEl.innerHTML = '<div class="subscribers-list-title">Subscribers</div>'
          + '<div class="no-subscribers">No subscribers yet</div>';
      } else {
        preloadAvatars(subs).then(function() {
          var items = subs.map(function(u) {
            return '<div class="subscriber-item" onclick="viewUserProfile(\'' + escapeHtml(u) + '\')">'
              + getAvatarHtml(u) + ' ' + escapeHtml(u)
              + '</div>';
          }).join('');
          listEl.innerHTML = '<div class="subscribers-list-title">Subscribers (' + subs.length + ')</div>' + items;
        });
        var items = subs.map(function(u) {
          return '<div class="subscriber-item" onclick="viewUserProfile(\'' + escapeHtml(u) + '\')">'
            + getAvatarHtml(u) + ' ' + escapeHtml(u)
            + '</div>';
        }).join('');
        listEl.innerHTML = '<div class="subscribers-list-title">Subscribers (' + subs.length + ')</div>' + items;
      }
      listEl.classList.remove('hidden');
    } else {
      listEl.classList.add('hidden');
    }
  }

  function getSubscriptionCount(username) {
    if (!cachedSubscriptions[username]) return 0;
    return Object.keys(cachedSubscriptions[username]).length;
  }

  // ===== COMMENTS =====
  function toggleComments(videoId) {
    expandedComments[videoId] = !expandedComments[videoId];
    renderFeed();
    // If we just expanded, focus the input
    if (expandedComments[videoId]) {
      var input = document.getElementById('comment-' + videoId);
      if (input) input.focus();
    }
  }

  function postComment(videoId) {
    var input = document.getElementById('comment-' + videoId);
    if (!input) return;
    var text = input.value.trim();
    if (!text) return;

    // Check comment for inappropriate content
    var commentCheck = checkContentModeration(text);
    if (!commentCheck.ok) {
      alert(commentCheck.message);
      return;
    }

    var commentId = Date.now().toString(36) + Math.random().toString(36).slice(2, 5);
    db.ref('videos/' + videoId + '/comments/' + commentId).set({
      author: getCurrentUser(),
      text: text,
      created: Date.now()
    });
    input.value = '';
  }

  function timeAgo(timestamp) {
    var diff = Date.now() - timestamp;
    var mins = Math.floor(diff / 60000);
    if (mins < 1) return 'now';
    if (mins < 60) return mins + 'm';
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h';
    var days = Math.floor(hrs / 24);
    return days + 'd';
  }

  // ===== FILE SELECT =====
  function handleFileSelect(input) {
    var btn = document.getElementById('fileUploadBtn');
    if (input.files && input.files[0]) {
      var file = input.files[0];
      var sizeMB = (file.size / 1024 / 1024).toFixed(1);
      btn.textContent = '✅ ' + file.name + ' (' + sizeMB + ' MB)';
      btn.classList.add('has-file');
      // Clear URL input since they're uploading a file
      document.getElementById('postUrl').value = '';
    } else {
      btn.textContent = '📁 TAP TO UPLOAD A VIDEO OR PHOTO';
      btn.classList.remove('has-file');
    }
  }

  // ===== FACE DETECTION =====
  let faceApiLoaded = false;
  let faceApiLoading = false;

  async function loadFaceApi() {
    if (faceApiLoaded) return true;
    if (faceApiLoading) {
      // Wait for it to finish loading
      while (faceApiLoading) {
        await new Promise(r => setTimeout(r, 100));
      }
      return faceApiLoaded;
    }

    faceApiLoading = true;
    try {
      // Load the tiny face detector model from CDN
      await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model');
      faceApiLoaded = true;
    } catch (err) {
      console.error('Failed to load face detection:', err);
      faceApiLoaded = false;
    }
    faceApiLoading = false;
    return faceApiLoaded;
  }

  async function detectFaceInImage(file) {
    return new Promise(async (resolve) => {
      const img = new Image();
      img.onload = async function() {
        try {
          const detections = await faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.65 }));
          resolve(detections.length > 0);
        } catch (err) {
          console.error('Face detection error:', err);
          resolve(false); // If detection fails, allow upload
        }
      };
      img.onerror = function() {
        resolve(false); // If image fails to load, allow upload
      };
      img.src = URL.createObjectURL(file);
    });
  }

  async function detectFaceInVideo(file) {
    return new Promise(async (resolve) => {
      const video = document.createElement('video');
      video.muted = true;
      video.playsInline = true;

      video.onloadeddata = async function() {
        try {
          // Check multiple frames (start, 25%, 50%, 75%)
          const duration = video.duration || 10;
          const times = [0.1, duration * 0.25, duration * 0.5, duration * 0.75];

          for (let time of times) {
            if (time >= duration) continue;
            video.currentTime = Math.min(time, duration - 0.1);
            await new Promise(r => { video.onseeked = r; });

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.65 }));
            if (detections.length > 0) {
              URL.revokeObjectURL(video.src);
              resolve(true);
              return;
            }
          }
          URL.revokeObjectURL(video.src);
          resolve(false);
        } catch (err) {
          console.error('Video face detection error:', err);
          URL.revokeObjectURL(video.src);
          resolve(false); // If detection fails, allow upload
        }
      };

      video.onerror = function() {
        resolve(false); // If video fails to load, allow upload
      };

      video.src = URL.createObjectURL(file);
      video.load();
    });
  }

  // ===== CONTENT MODERATION =====
  // Bad words list (covers swears, slurs, inappropriate content)
  const badWordsList = [
    // Actual swear words
    'fuck', 'shit', 'bitch', 'cunt', 'whore', 'slut', 'hoe', 'thot',
    'dick', 'cock', 'pussy',
    // Slurs
    'fag', 'faggot', 'retard', 'retarded', 'nigger', 'nigga', 'chink', 'spic', 'kike', 'gook',
    'tranny', 'dyke',
    // Self-harm / violence
    'kill yourself', 'kys', 'kms',
    // Explicit / inappropriate content
    'sex', 'nude', 'naked', 'porn', 'boobs', 'tits', 'penis', 'vagina',
    'horny', 'turned on', 'hookup', 'hook up',
    // Personal info requests
    'phone number', 'where do you live', 'what school',
    // Leetspeak bypasses of actual swears
    'f*ck', 'sh*t', 'b*tch', 'a$$', 'd!ck', 'p*ssy', 'fck', 'sht', 'btch',
    'f u c k', 's h i t', 'b i t c h', 'fuk', 'phuck', 'shiit', 'biatch',
    // Abbreviations of actual swears
    'stfu', 'gtfo'
  ];

  // Patterns for detecting personal info
  const personalInfoPatterns = [
    /\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/,  // Phone numbers
    /\b\d{5}(-\d{4})?\b/,  // ZIP codes
    /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/,  // Email addresses
    /\b\d+\s+[A-Za-z]+\s+(street|st|avenue|ave|road|rd|drive|dr|lane|ln|court|ct|boulevard|blvd)\b/i  // Addresses
  ];

  function checkContentModeration(text) {
    if (!text) return { ok: true };

    const lowerText = text.toLowerCase().trim();

    // Check for bad words
    for (const word of badWordsList) {
      // Check for exact word match — only use includes() for phrases (2+ words)
      const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp('\\b' + escaped + '\\b', 'i');
      const isPhrase = word.includes(' ');
      if (regex.test(lowerText) || (isPhrase && lowerText.includes(word.toLowerCase()))) {
        return {
          ok: false,
          reason: 'inappropriate language',
          message: '🚫 That contains inappropriate content! Please keep it clean and kind.'
        };
      }
    }

    // Check for personal info patterns
    for (const pattern of personalInfoPatterns) {
      if (pattern.test(text)) {
        return {
          ok: false,
          reason: 'personal information',
          message: '🚫 Don\'t share personal info like phone numbers, emails, or addresses!'
        };
      }
    }

    // Check for excessive caps (yelling/aggressive)
    const capsRatio = (text.match(/[A-Z]/g) || []).length / text.length;
    if (text.length > 10 && capsRatio > 0.7) {
      return {
        ok: false,
        reason: 'excessive caps',
        message: '🚫 Please don\'t use ALL CAPS - it looks like yelling!'
      };
    }

    // Check for spam (repeated characters)
    if (/(.)\1{4,}/.test(text)) {
      return {
        ok: false,
        reason: 'spam',
        message: '🚫 Please don\'t spam repeated characters!'
      };
    }

    // Check for sneaky negative patterns (variations kids use)
    const sneakyPatterns = [
      /\bkill\s*(your|ur)\s*self\b/i,        // "kill yourself"
      /\bno\s*one\s*(likes|wants)\s+(u|you)\b/i,  // "no one likes you"
      /\beveryone\s*hates\s+(u|you)\b/i,
      /\bfatherless\b/i,
      /\bmotherless\b/i
    ];

    for (const pattern of sneakyPatterns) {
      if (pattern.test(lowerText)) {
        return {
          ok: false,
          reason: 'mean content',
          message: '🚫 Let\'s keep it positive! That message might hurt someone\'s feelings.'
        };
      }
    }

    return { ok: true };
  }

  // ===== POST VIDEO =====
  async function postVideo() {
    var title = document.getElementById('postTitle').value.trim();
    var url = document.getElementById('postUrl').value.trim();
    var fileInput = document.getElementById('postFile');
    var file = fileInput.files && fileInput.files[0];
    var successEl = document.getElementById('postSuccess');
    var postBtn = document.getElementById('postBtn');

    if (!title) {
      successEl.style.color = '#ff4444';
      successEl.textContent = 'Give it a title bro!! 😤';
      return;
    }

    // Check title for inappropriate content
    var titleCheck = checkContentModeration(title);
    if (!titleCheck.ok) {
      successEl.style.color = '#ff4444';
      successEl.textContent = titleCheck.message;
      return;
    }

    if (!file && !url) {
      successEl.style.color = '#ff4444';
      successEl.textContent = 'Upload a file or paste a link!! 😤';
      return;
    }

    var id = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);

    if (file) {
      // File upload path
      var isImage = file.type.startsWith('image/');
      var isVideo = file.type.startsWith('video/');
      if (!isImage && !isVideo) {
        successEl.style.color = '#ff4444';
        successEl.textContent = 'Only photos and videos!! 🤨';
        return;
      }

      // Max 100MB
      if (file.size > 100 * 1024 * 1024) {
        successEl.style.color = '#ff4444';
        successEl.textContent = 'File too big! Max 100MB 😵';
        return;
      }

      postBtn.disabled = true;
      postBtn.textContent = 'CHECKING FOR FACES... 🔍';
      successEl.style.color = '#0ff';
      successEl.textContent = 'Scanning for faces (this keeps everyone safe!)';

      // Load face detection if needed
      var modelLoaded = await loadFaceApi();

      if (modelLoaded) {
        var hasFace = false;
        if (isImage) {
          hasFace = await detectFaceInImage(file);
        } else {
          hasFace = await detectFaceInVideo(file);
        }

        if (hasFace) {
          successEl.style.color = '#ff4444';
          successEl.textContent = '🚫 FACE DETECTED! For safety, no face pics allowed. Try a different photo/video!';
          postBtn.disabled = false;
          postBtn.textContent = 'POST IT! 🎬';
          return;
        }
      }

      // No face detected - proceed with upload
      postBtn.textContent = 'UPLOADING... 0%';
      successEl.textContent = '';
      var progressEl = document.getElementById('uploadProgress');
      var progressBar = document.getElementById('progressBar');
      progressEl.style.display = 'block';

      var ref = storage.ref('uploads/' + id + '/' + file.name);
      var uploadTask = ref.put(file);

      uploadTask.on('state_changed',
        function(snapshot) {
          var pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
          progressBar.style.width = pct + '%';
          postBtn.textContent = 'UPLOADING... ' + pct + '%';
        },
        function(error) {
          successEl.style.color = '#ff4444';
          successEl.textContent = 'Upload failed! 😵';
          console.error(error);
          postBtn.disabled = false;
          postBtn.textContent = 'POST IT! 🎬';
          progressEl.style.display = 'none';
        },
        function() {
          uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
            db.ref('videos/' + id).set({
              title: title,
              url: downloadURL,
              type: isImage ? 'image' : 'video',
              author: getCurrentUser(),
              created: Date.now()
            }).then(function() {
              document.getElementById('postTitle').value = '';
              document.getElementById('postUrl').value = '';
              fileInput.value = '';
              document.getElementById('fileUploadBtn').textContent = '📁 TAP TO UPLOAD A VIDEO OR PHOTO';
              document.getElementById('fileUploadBtn').classList.remove('has-file');
              progressEl.style.display = 'none';
              progressBar.style.width = '0%';
              postBtn.disabled = false;
              postBtn.textContent = 'POST IT! 🎬';
              successEl.style.color = '#0f0';
              successEl.textContent = 'POSTED!! 🎉🔥 GO CHECK THE FEED!';
            });
          });
        }
      );
    } else {
      // URL path (existing behavior)
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        successEl.style.color = '#ff4444';
        successEl.textContent = 'That doesn\'t look like a link! 🤨';
        return;
      }

      db.ref('videos/' + id).set({
        title: title,
        url: url,
        type: 'link',
        author: getCurrentUser(),
        created: Date.now()
      }).then(function() {
        document.getElementById('postTitle').value = '';
        document.getElementById('postUrl').value = '';
        successEl.style.color = '#0f0';
        successEl.textContent = 'POSTED!! 🎉🔥 GO CHECK THE FEED!';
      }).catch(function(err) {
        successEl.style.color = '#ff4444';
        successEl.textContent = 'Firebase error! Check console 😵';
        console.error(err);
      });
    }
  }

  // ===== LEADERBOARD =====
  function renderLeaderboard() {
    const videos = cachedVideos;
    const container = document.getElementById('leaderboardList');

    // Check if user earned the 5-subscriber reward
    checkSubReward();

    // Render sub reward banner
    renderSubRewardBanner();

    // Aggregate per user from videos
    const userStats = {};
    videos.forEach(v => {
      if (!userStats[v.author]) {
        userStats[v.author] = { totalRating: 0, totalVotes: 0, videoCount: 0 };
      }
      userStats[v.author].videoCount++;
      v.votes.forEach(vote => {
        userStats[v.author].totalRating += vote.rating;
        userStats[v.author].totalVotes++;
      });
    });

    // Include ALL registered users (even those with no posts)
    Object.keys(cachedUsers).forEach(function(u) {
      if (!userStats[u]) {
        userStats[u] = { totalRating: 0, totalVotes: 0, videoCount: 0 };
      }
    });

    // Build sorted list - all users, sorted by avg rating then by video count
    const ranked = Object.entries(userStats)
      .map(([user, stats]) => ({
        user,
        avg: stats.totalVotes > 0 ? stats.totalRating / stats.totalVotes : 0,
        totalVotes: stats.totalVotes,
        videoCount: stats.videoCount
      }))
      .sort((a, b) => b.avg - a.avg || b.totalVotes - a.totalVotes || b.videoCount - a.videoCount);

    if (ranked.length === 0) {
      container.innerHTML = '<div class="leaderboard-empty">No users yet! 🗳️</div>';
      return;
    }

    // Preload avatars for all users then render
    var leaderboardUsers = ranked.map(function(e) { return e.user; });
    preloadAvatars(leaderboardUsers).then(function() {
      container.innerHTML = ranked.map((entry, i) => {
        const rank = i + 1;
        const rankClass = rank <= 3 ? ' rank-' + rank : '';
        const medal = rank === 1 ? '👑' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : '#' + rank;
        const isKing = rank === 1 && entry.totalVotes > 0;

        var userRefCount = getReferralCount(entry.user);
        var has5Refs = userRefCount >= 5;
        var userFreeSpins = cachedFreeSpins[entry.user] || 0;
        var claimedReward = subRewardClaimed[entry.user];
        var userSubCount = getSubscriberCount(entry.user);

        return '<li class="leaderboard-item' + rankClass + '">'
          + '<div class="leaderboard-rank">' + medal + '</div>'
          + '<div class="leaderboard-info">'
          + '<div class="leaderboard-username">'
          + getClickableUsername(entry.user)
          + (isKing ? ' <span class="rizz-king-badge">👑</span>' : '')
          + (claimedReward ? ' <span class="free-spins-badge" style="font-size:0.75rem;">🎡 REWARD</span>' : '')
          + '</div>'
          + (isKing ? '<div class="rizz-king-label">✨ RIZZ KING ✨</div>' : '')
          + '<div class="leaderboard-details">'
          + entry.videoCount + ' video' + (entry.videoCount !== 1 ? 's' : '')
          + ' · ' + entry.totalVotes + ' vote' + (entry.totalVotes !== 1 ? 's' : '')
          + ' · ' + userSubCount + ' sub' + (userSubCount !== 1 ? 's' : '')
          + (userRefCount > 0 ? ' · ' + userRefCount + ' referral' + (userRefCount !== 1 ? 's' : '') : '')
          + (has5Refs && !claimedReward ? ' · <span style="color:gold;">🎡 Reward ready!</span>' : '')
          + (userFreeSpins > 0 ? ' · <span style="color:gold;">' + userFreeSpins + ' free spin' + (userFreeSpins !== 1 ? 's' : '') + '</span>' : '')
          + '</div>'
          + '</div>'
          + '<div class="leaderboard-score">' + (entry.totalVotes > 0 ? entry.avg.toFixed(1) : '-') + '</div>'
          + '</li>';
      }).join('');
    });
  }

  // ===== PROFILE =====
  function renderProfile() {
    const currentUser = getCurrentUser();
    const targetUser = viewingUser || currentUser;
    const isOwnProfile = !viewingUser;
    const videos = cachedVideos;
    // Hide subscribers list when re-rendering profile
    var subsList = document.getElementById('subscribersList');
    if (subsList) subsList.classList.add('hidden');
    const userVideos = videos.filter(v => v.author === targetUser);

    // Load profile data from cache or Firebase
    loadUserProfile(targetUser).then(function(profile) {
      var profileColor = profile.profileColor || '#00ffff';

      // Page title
      var titleEl = document.querySelector('#profilePage .page-title');
      if (titleEl) {
        titleEl.style.color = profileColor;
        titleEl.innerHTML = isOwnProfile ? '😎 YOUR PROFILE 😎' : '👤 ' + escapeHtml(targetUser) + '\'s PROFILE 👤';
      }

      // Avatar display
      var avatarEl = document.querySelector('#profilePage .profile-avatar');
      if (avatarEl) {
        if (profile.profilePhoto) {
          avatarEl.innerHTML = '<img class="profile-avatar-img" src="' + escapeHtml(profile.profilePhoto) + '" alt="">';
        } else {
          avatarEl.textContent = profile.avatar || '😎';
          avatarEl.style.cssText = '';
        }
      }

      // Username
      var usernameEl = document.getElementById('profileUsername');
      usernameEl.textContent = targetUser;
      usernameEl.style.color = profileColor;

      // Bio
      var bioEl = document.getElementById('profileBio');
      if (!bioEl) {
        bioEl = document.createElement('div');
        bioEl.id = 'profileBio';
        bioEl.className = 'profile-bio';
        usernameEl.parentNode.insertBefore(bioEl, usernameEl.nextSibling);
      }
      bioEl.textContent = profile.bio || '';
      bioEl.style.display = profile.bio ? '' : 'none';

      // Stats
      document.getElementById('profileVideos').textContent = userVideos.length;
      let totalRating = 0, totalVotes = 0;
      userVideos.forEach(v => {
        v.votes.forEach(vote => {
          totalRating += vote.rating;
          totalVotes++;
        });
      });
      document.getElementById('profileTotalVotes').textContent = totalVotes;
      document.getElementById('profileAvgRating').textContent = totalVotes > 0
        ? (totalRating / totalVotes).toFixed(1)
        : '-';
      document.getElementById('profileSubscribers').textContent = getSubscriberCount(targetUser);
      document.getElementById('profileSubscriptions').textContent = getSubscriptionCount(targetUser);

      // Action buttons area
      var settingsBtnEl = document.querySelector('#profilePage .settings-btn');
      var editProfileBtnEl = document.getElementById('profileEditBtn');
      var subscribeBtnEl = document.getElementById('profileSubscribeBtn');
      var backBtnEl = document.getElementById('profileBackBtn');

      var dmBtnEl = document.getElementById('profileDmBtn');

      // Remove old dynamic buttons
      if (editProfileBtnEl) editProfileBtnEl.remove();
      if (subscribeBtnEl) subscribeBtnEl.remove();
      if (backBtnEl) backBtnEl.remove();
      if (dmBtnEl) dmBtnEl.remove();

      var headerEl = document.querySelector('#profilePage .profile-header');

      if (isOwnProfile) {
        // Show settings + Edit Profile button
        if (settingsBtnEl) settingsBtnEl.style.display = '';
        var editBtn = document.createElement('button');
        editBtn.id = 'profileEditBtn';
        editBtn.className = 'edit-profile-btn';
        editBtn.textContent = 'Edit Profile';
        editBtn.onclick = openEditProfileModal;
        headerEl.appendChild(editBtn);
      } else {
        // Hide settings, show subscribe + back
        if (settingsBtnEl) settingsBtnEl.style.display = 'none';

        // Back button at top of page
        var backBtn = document.createElement('button');
        backBtn.id = 'profileBackBtn';
        backBtn.className = 'back-btn';
        backBtn.textContent = '← Back';
        backBtn.onclick = function() { viewingUser = null; showPage('feed'); };
        var container = document.getElementById('profilePage');
        container.insertBefore(backBtn, container.firstChild);

        // Subscribe button
        var isSub = cachedSubscriptions[currentUser] && cachedSubscriptions[currentUser][targetUser];
        var subBtn = document.createElement('button');
        subBtn.id = 'profileSubscribeBtn';
        subBtn.className = 'subscribe-btn' + (isSub ? ' subscribed' : '');
        subBtn.style.cssText = 'margin-top:12px;font-size:1rem;padding:8px 24px;';
        subBtn.textContent = isSub ? 'Subscribed' : 'Subscribe';
        subBtn.onclick = function() { toggleSubscribe(targetUser); renderProfile(); };
        headerEl.appendChild(subBtn);

        // DM button
        var dmBtnEl = document.getElementById('profileDmBtn');
        if (dmBtnEl) dmBtnEl.remove();
        var dmBtn = document.createElement('button');
        dmBtn.id = 'profileDmBtn';
        dmBtn.className = 'dm-profile-btn';
        dmBtn.textContent = '💬 Message';
        dmBtn.onclick = function() { openDMFromProfile(targetUser); };
        headerEl.appendChild(dmBtn);
      }

      // Videos title
      var vidTitle = document.querySelector('#profilePage .profile-videos-title');
      vidTitle.textContent = isOwnProfile ? 'Your Videos' : targetUser + '\'s Videos';

      // Videos list
      const listEl = document.getElementById('profileVideosList');
      if (userVideos.length === 0) {
        listEl.innerHTML = '<div class="no-videos">' + (isOwnProfile ? 'You haven\'t posted any videos yet! 🎬' : 'No videos yet!') + '</div>';
        return;
      }

      listEl.innerHTML = [...userVideos].sort((a, b) => b.created - a.created).map(v => {
        const avgRating = v.votes.length > 0
          ? (v.votes.reduce((sum, vote) => sum + vote.rating, 0) / v.votes.length).toFixed(1)
          : '-';
        var postActions = '';
        if (v.author === currentUser || isAdmin) {
          postActions = '<div class="post-actions">'
            + '<button onclick="editPost(\'' + v.id + '\')">✏️ Edit</button>'
            + '<button class="delete-btn" onclick="deletePost(\'' + v.id + '\')">🗑️ Delete</button>'
            + '</div>';
        }

        return '<div class="video-card">'
          + '<div class="video-header">'
          + '<div class="video-title">' + escapeHtml(v.title) + '</div>'
          + postActions
          + '</div>'
          + '<div class="video-embed">' + renderVideoEmbed(v) + '</div>'
          + '<div class="video-stats">'
          + '<span class="avg-rating">⭐ ' + avgRating + '/10</span>'
          + '<span class="vote-count">' + v.votes.length + ' vote' + (v.votes.length !== 1 ? 's' : '') + '</span>'
          + '</div>'
          + '</div>';
      }).join('');
    });
  }

  // ===== AVATAR / PROFILE HELPERS =====
  function loadUserProfile(username) {
    if (avatarCache[username]) return Promise.resolve(avatarCache[username]);
    return db.ref('users/' + username).once('value').then(function(snap) {
      var data = snap.val() || {};
      var profile = {
        avatar: data.avatar || '😎',
        bio: data.bio || '',
        profileColor: data.profileColor || '#00ffff',
        profilePhoto: data.profilePhoto || ''
      };
      avatarCache[username] = profile;
      return profile;
    });
  }

  function getAvatarHtml(username) {
    var cached = avatarCache[username];
    if (cached && cached.profilePhoto) {
      return '<img class="inline-avatar-img" src="' + escapeHtml(cached.profilePhoto) + '" alt="">';
    }
    var emoji = (cached && cached.avatar) ? cached.avatar : '😎';
    return '<span class="inline-avatar">' + emoji + '</span>';
  }

  function getClickableUsername(username) {
    var badges = getPrizeBadges(username);
    var nameClass = '';
    if (userPrizes[username]) {
      if (userPrizes[username]['rainbow-name']) nameClass = ' prize-rainbow-name';
      else if (userPrizes[username]['neon-glow']) nameClass = ' prize-neon-glow';
    }
    return '<span class="clickable-user' + nameClass + '" onclick="viewUserProfile(\'' + escapeHtml(username) + '\')">' + getAvatarHtml(username) + ' ' + escapeHtml(username) + badges + '</span>';
  }

  function getPrizeBadges(username) {
    var prizes = userPrizes[username];
    if (!prizes) return '';
    var badges = '';
    if (prizes['diamond-badge']) badges += '<span class="prize-badge">💎</span>';
    if (prizes['lightning-badge']) badges += '<span class="prize-badge">⚡</span>';
    if (prizes['star-badge']) badges += '<span class="prize-badge">⭐</span>';
    if (prizes['crown-upgrade']) badges += '<span class="prize-badge">👑</span>';
    return badges;
  }

  function preloadAvatars(usernames) {
    var toLoad = usernames.filter(function(u) { return !avatarCache[u]; });
    if (toLoad.length === 0) return Promise.resolve();
    var promises = toLoad.map(function(u) { return loadUserProfile(u); });
    return Promise.all(promises);
  }

  // ===== VIEW OTHER USER'S PROFILE =====
  function viewUserProfile(username) {
    viewingUser = username === getCurrentUser() ? null : username;
    showPage('profile');
  }

  // ===== EDIT PROFILE MODAL =====
  function openEditProfileModal() {
    var currentUser = getCurrentUser();
    var cached = avatarCache[currentUser] || {};
    var currentAvatar = cached.avatar || '😎';
    var currentBio = cached.bio || '';
    var currentColor = cached.profileColor || '#00ffff';
    var currentPhoto = cached.profilePhoto || '';

    pendingProfilePhoto = null;

    // Set photo preview
    var photoPreview = document.getElementById('editProfilePhotoPreview');
    var emojiPreview = document.getElementById('editProfileEmojiPreview');
    if (currentPhoto) {
      photoPreview.src = currentPhoto;
      photoPreview.style.display = 'block';
      emojiPreview.style.display = 'none';
    } else {
      photoPreview.style.display = 'none';
      emojiPreview.style.display = '';
      emojiPreview.textContent = currentAvatar;
    }

    // Build emoji grid
    var grid = document.getElementById('emojiGrid');
    grid.innerHTML = PROFILE_EMOJIS.map(function(e) {
      return '<button type="button" onclick="selectProfileEmoji(this, \'' + e + '\')"'
        + (e === currentAvatar ? ' class="selected"' : '')
        + '>' + e + '</button>';
    }).join('');

    // Bio
    document.getElementById('editBioInput').value = currentBio;
    updateBioCount();

    // Color swatches
    var swatches = document.getElementById('colorSwatches');
    swatches.innerHTML = PROFILE_COLORS.map(function(c) {
      return '<div class="color-swatch' + (c === currentColor ? ' selected' : '') + '"'
        + ' style="background:' + c + ';"'
        + ' onclick="selectProfileColor(this, \'' + c + '\')"></div>';
    }).join('');

    document.getElementById('editProfileModal').classList.remove('hidden');
  }

  function closeEditProfileModal() {
    document.getElementById('editProfileModal').classList.add('hidden');
    pendingProfilePhoto = null;
  }

  function selectProfileEmoji(btn, emoji) {
    document.querySelectorAll('#emojiGrid button').forEach(function(b) { b.classList.remove('selected'); });
    btn.classList.add('selected');
    var emojiPreview = document.getElementById('editProfileEmojiPreview');
    emojiPreview.textContent = emoji;
    // If no photo, show emoji preview
    if (document.getElementById('editProfilePhotoPreview').style.display === 'none') {
      emojiPreview.style.display = '';
    }
  }

  function selectProfileColor(swatch, color) {
    document.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('selected'); });
    swatch.classList.add('selected');
  }

  function handleProfilePhotoSelect(input) {
    if (input.files && input.files[0]) {
      var file = input.files[0];
      if (!file.type.startsWith('image/')) {
        alert('Only images allowed!');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('Photo must be under 5MB!');
        return;
      }
      pendingProfilePhoto = file;
      var reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('editProfilePhotoPreview').src = e.target.result;
        document.getElementById('editProfilePhotoPreview').style.display = 'block';
        document.getElementById('editProfileEmojiPreview').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }
  }

  function clearProfilePhoto() {
    pendingProfilePhoto = null;
    document.getElementById('editProfilePhotoPreview').style.display = 'none';
    document.getElementById('editProfileEmojiPreview').style.display = '';
    document.getElementById('profilePhotoFile').value = '';
  }

  function updateBioCount() {
    var bio = document.getElementById('editBioInput').value;
    document.getElementById('bioCharCount').textContent = bio.length;
  }

  async function saveProfile() {
    var currentUser = getCurrentUser();
    var selectedEmoji = '😎';
    var emojiBtn = document.querySelector('#emojiGrid button.selected');
    if (emojiBtn) selectedEmoji = emojiBtn.textContent;

    var bio = document.getElementById('editBioInput').value.trim();
    if (bio) {
      var bioCheck = checkContentModeration(bio);
      if (!bioCheck.ok) {
        alert(bioCheck.message);
        return;
      }
    }

    var selectedColor = '#00ffff';
    var colorSwatch = document.querySelector('.color-swatch.selected');
    if (colorSwatch) selectedColor = colorSwatch.style.background || colorSwatch.style.backgroundColor;

    var updates = {
      avatar: selectedEmoji,
      bio: bio,
      profileColor: selectedColor
    };

    // Upload profile photo if one was selected
    if (pendingProfilePhoto) {
      var saveBtn = document.querySelector('.edit-profile-save');
      saveBtn.textContent = 'UPLOADING PHOTO...';
      saveBtn.disabled = true;

      try {
        // Check for faces
        var modelLoaded = await loadFaceApi();
        if (modelLoaded) {
          var hasFace = await detectFaceInImage(pendingProfilePhoto);
          if (hasFace) {
            alert('Face detected! For safety, no face pics allowed. Try a different photo!');
            saveBtn.textContent = 'SAVE PROFILE';
            saveBtn.disabled = false;
            return;
          }
        }

        var ref = storage.ref('profile-photos/' + currentUser + '/' + Date.now());
        await ref.put(pendingProfilePhoto);
        var downloadURL = await ref.getDownloadURL();
        updates.profilePhoto = downloadURL;

        saveBtn.textContent = 'SAVE PROFILE';
        saveBtn.disabled = false;
      } catch (err) {
        console.error('Profile photo upload failed:', err);
        alert('Photo upload failed! Try again.');
        saveBtn.textContent = 'SAVE PROFILE';
        saveBtn.disabled = false;
        return;
      }
    } else if (document.getElementById('editProfilePhotoPreview').style.display === 'none') {
      // Photo was cleared
      updates.profilePhoto = '';
    }

    await db.ref('users/' + currentUser).update(updates);
    avatarCache[currentUser] = {
      avatar: updates.avatar,
      bio: updates.bio,
      profileColor: updates.profileColor,
      profilePhoto: updates.profilePhoto !== undefined ? updates.profilePhoto : ((avatarCache[currentUser] || {}).profilePhoto || '')
    };

    closeEditProfileModal();
    renderProfile();
    // Update nav avatar
    document.getElementById('navUsername').innerHTML = getAvatarHtml(currentUser) + ' ' + escapeHtml(currentUser);
  }

  // ===== ADMIN SYSTEM =====
  // Admin panel is at /admin.html
  // This just tracks if user is admin for showing edit/delete buttons on all posts
  let isAdmin = false;

  function checkAdminStatus() {
    var currentUser = getCurrentUser();
    if (!currentUser) {
      isAdmin = false;
      return;
    }
    db.ref('admins/' + currentUser).once('value').then(function(snapshot) {
      isAdmin = snapshot.exists() && snapshot.val() === true;
      // Re-render feed to show edit/delete buttons if admin
      if (isAdmin && document.getElementById('feedPage') && !document.getElementById('feedPage').classList.contains('hidden')) {
        renderFeed();
      }
    });
  }

  // ===== EDIT MODAL =====
  let editModalCallback = null;

  function showEditModal(title, currentValue, callback) {
    document.getElementById('editModalTitle').textContent = title;
    document.getElementById('editModalInput').value = currentValue;
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editModalInput').focus();
    editModalCallback = callback;
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    editModalCallback = null;
  }

  function saveEditModal() {
    var newValue = document.getElementById('editModalInput').value;
    if (editModalCallback) {
      editModalCallback(newValue);
    }
    closeEditModal();
  }

  // Enter key to save
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !document.getElementById('editModal').classList.contains('hidden')) {
      saveEditModal();
    }
    if (e.key === 'Escape' && !document.getElementById('editModal').classList.contains('hidden')) {
      closeEditModal();
    }
    if (e.key === 'Escape' && !document.getElementById('editProfileModal').classList.contains('hidden')) {
      closeEditProfileModal();
    }
    if (e.key === 'Escape' && !document.getElementById('newMsgModal').classList.contains('hidden')) {
      closeNewMessageModal();
    }
  });

  // ===== SETTINGS MODAL =====
  function showSettingsModal() {
    document.getElementById('newUsernameInput').value = getCurrentUser();
    document.getElementById('settingsModal').classList.remove('hidden');
    document.getElementById('newUsernameInput').focus();
  }

  function closeSettingsModal() {
    document.getElementById('settingsModal').classList.add('hidden');
  }

  async function changeUsername() {
    var oldUsername = getCurrentUser();
    var newUsername = document.getElementById('newUsernameInput').value.trim().toLowerCase();

    if (!newUsername || newUsername === oldUsername) {
      closeSettingsModal();
      return;
    }

    if (newUsername.length < 2) {
      alert('Username must be at least 2 characters!');
      return;
    }

    // Check username for inappropriate content
    var usernameCheck = checkContentModeration(newUsername);
    if (!usernameCheck.ok) {
      alert('🚫 That username isn\'t allowed! Pick something nicer.');
      return;
    }

    // Check if new username exists
    var snap = await db.ref('users/' + newUsername).once('value');
    if (snap.exists()) {
      alert('That username is already taken!');
      return;
    }

    await migrateUsername(oldUsername, newUsername);
    setCurrentUser(newUsername);
    // Move avatar cache to new username
    if (avatarCache[oldUsername]) {
      avatarCache[newUsername] = avatarCache[oldUsername];
      delete avatarCache[oldUsername];
    }
    document.getElementById('navUsername').innerHTML = getAvatarHtml(newUsername) + ' ' + escapeHtml(newUsername);
    closeSettingsModal();
    renderProfile();
    alert('Username changed to "' + newUsername + '"!');
  }

  async function migrateUsername(oldUsername, newUsername) {
    // 1. Copy user data to new username
    var userData = await db.ref('users/' + oldUsername).once('value');
    await db.ref('users/' + newUsername).set(userData.val());

    // 2. Update all posts author
    var videosSnap = await db.ref('videos').once('value');
    var videos = videosSnap.val() || {};
    var updates = {};
    Object.keys(videos).forEach(function(vid) {
      if (videos[vid].author === oldUsername) {
        updates['videos/' + vid + '/author'] = newUsername;
      }
      // Update comments
      var comments = videos[vid].comments || {};
      Object.keys(comments).forEach(function(cid) {
        if (comments[cid].author === oldUsername) {
          updates['videos/' + vid + '/comments/' + cid + '/author'] = newUsername;
        }
      });
      // Update votes
      var votes = videos[vid].votes || {};
      if (votes[oldUsername] !== undefined) {
        updates['videos/' + vid + '/votes/' + newUsername] = votes[oldUsername];
        updates['videos/' + vid + '/votes/' + oldUsername] = null;
      }
    });

    // 3. Update subscriptions
    var subsSnap = await db.ref('subscriptions').once('value');
    var subs = subsSnap.val() || {};
    // Rename subscriber
    if (subs[oldUsername]) {
      updates['subscriptions/' + newUsername] = subs[oldUsername];
      updates['subscriptions/' + oldUsername] = null;
    }
    // Rename subscribed-to
    Object.keys(subs).forEach(function(user) {
      if (subs[user] && subs[user][oldUsername]) {
        updates['subscriptions/' + user + '/' + newUsername] = true;
        updates['subscriptions/' + user + '/' + oldUsername] = null;
      }
    });

    // 4. Update banned list if applicable
    var bannedSnap = await db.ref('banned/' + oldUsername).once('value');
    if (bannedSnap.exists()) {
      updates['banned/' + newUsername] = true;
      updates['banned/' + oldUsername] = null;
    }

    // 5. Update admin status if applicable
    var adminSnap = await db.ref('admins/' + oldUsername).once('value');
    if (adminSnap.exists()) {
      updates['admins/' + newUsername] = true;
      updates['admins/' + oldUsername] = null;
    }

    // Apply all updates
    await db.ref().update(updates);

    // 6. Delete old user
    await db.ref('users/' + oldUsername).remove();
  }

  // ===== USER POST/COMMENT EDIT/DELETE =====
  function editPost(videoId) {
    var video = cachedVideos.find(function(v) { return v.id === videoId; });
    if (!video || (video.author !== getCurrentUser() && !isAdmin)) return;
    showEditModal('Edit Post Title', video.title, function(newTitle) {
      if (!newTitle || newTitle === video.title) return;
      // Check for inappropriate content (admins bypass this)
      if (!isAdmin) {
        var check = checkContentModeration(newTitle);
        if (!check.ok) {
          alert(check.message);
          return;
        }
      }
      db.ref('videos/' + videoId + '/title').set(newTitle.trim());
    });
  }

  function deletePost(videoId) {
    var video = cachedVideos.find(function(v) { return v.id === videoId; });
    if (!video || (video.author !== getCurrentUser() && !isAdmin)) return;
    if (confirm('Delete this post? This cannot be undone!')) {
      db.ref('videos/' + videoId).remove();
      // Also delete from storage if it's an uploaded file
      if (video.type === 'image' || video.type === 'video') {
        storage.ref('uploads/' + videoId).listAll().then(function(res) {
          res.items.forEach(function(item) { item.delete(); });
        }).catch(function() {});
      }
    }
  }

  function editComment(videoId, commentId) {
    var video = cachedVideos.find(function(v) { return v.id === videoId; });
    if (!video) return;
    var comment = video.comments.find(function(c) { return c.id === commentId; });
    if (!comment || (comment.author !== getCurrentUser() && !isAdmin)) return;
    showEditModal('Edit Comment', comment.text, function(newText) {
      if (!newText || newText === comment.text) return;
      // Check for inappropriate content (admins bypass this)
      if (!isAdmin) {
        var check = checkContentModeration(newText);
        if (!check.ok) {
          alert(check.message);
          return;
        }
      }
      db.ref('videos/' + videoId + '/comments/' + commentId + '/text').set(newText.trim());
    });
  }

  function deleteComment(videoId, commentId) {
    var video = cachedVideos.find(function(v) { return v.id === videoId; });
    if (!video) return;
    var comment = video.comments.find(function(c) { return c.id === commentId; });
    if (!comment || (comment.author !== getCurrentUser() && !isAdmin)) return;
    if (confirm('Delete this comment?')) {
      db.ref('videos/' + videoId + '/comments/' + commentId).remove();
    }
  }

  // ===== FEATURE TILES UPDATE =====
  // ===== ANNOUNCEMENT & ADS =====
  function dismissAnnouncement() {
    var banner = document.getElementById('announcementBanner');
    if (banner) banner.style.display = 'none';
    sessionStorage.setItem('vrizz_announce_dismissed', 'true');
  }

  function checkAnnouncementDismissed() {
    if (sessionStorage.getItem('vrizz_announce_dismissed') === 'true') {
      var banner = document.getElementById('announcementBanner');
      if (banner) banner.style.display = 'none';
    }
  }

  var AD_POOL = [
    {
      title: '🎬 POST YOUR BEST VIDEO!',
      text: 'Show off your skills! Upload a video and see how the community rates you.',
      cta: 'POST NOW',
      ctaColor: 'linear-gradient(135deg, #ff00ff, #ff0080)',
      ctaTextColor: '#fff',
      action: function() { showPage('post'); }
    },
    {
      title: '👑 CLIMB THE LEADERBOARD!',
      text: 'Get votes on your videos to rise up the ranks. Can you become the Rizz King?',
      cta: 'VIEW LEADERBOARD',
      ctaColor: 'linear-gradient(135deg, gold, #ff8c00)',
      ctaTextColor: '#0f0024',
      action: function() { showPage('leaderboard'); }
    },
    {
      title: '🤝 REFER FRIENDS = FREE SPINS!',
      text: 'Tell 5 friends about vote.rizz and earn 4 FREE wheel spins! Share the link!',
      cta: 'SHARE NOW',
      ctaColor: 'linear-gradient(135deg, #00ffff, #00ff88)',
      ctaTextColor: '#0f0024',
      action: function() {
        if (navigator.share) {
          navigator.share({ title: 'vote.rizz', text: 'Check out vote.rizz - post videos and get rated!', url: 'https://voterizz.onrender.com' });
        } else {
          navigator.clipboard.writeText('https://voterizz.onrender.com').then(function() { alert('Link copied!'); });
        }
      }
    },
    {
      title: '🎡 SPIN THE RIZZ WHEEL!',
      text: 'Win cool prizes like Golden Borders, Rainbow Names, and Diamond Badges!',
      cta: 'CHECK IT OUT',
      ctaColor: 'linear-gradient(135deg, #8800ff, #ff00ff)',
      ctaTextColor: '#fff',
      action: function() { showPage('wheel'); }
    },
    {
      title: '💬 SEND A MESSAGE!',
      text: 'Chat with other users! DM your friends right here on vote.rizz.',
      cta: 'OPEN MESSAGES',
      ctaColor: 'linear-gradient(135deg, #ff00ff, #8800ff)',
      ctaTextColor: '#fff',
      action: function() { showPage('messages'); }
    }
  ];

  function getAdHtml(index) {
    var ad = AD_POOL[index % AD_POOL.length];
    return '<div class="ad-banner">'
      + '<div class="ad-label">ad</div>'
      + '<div class="ad-title" style="color:#ff00ff;">' + ad.title + '</div>'
      + '<div class="ad-text">' + ad.text + '</div>'
      + '<button class="ad-cta" style="background:' + ad.ctaColor + ';color:' + ad.ctaTextColor + ';" onclick="AD_POOL[' + (index % AD_POOL.length) + '].action()">' + ad.cta + '</button>'
      + '</div>';
  }

  function updateFeatureTiles() {
    var currentUser = getCurrentUser();
    if (!currentUser) return;

    // Update messages tile
    var msgSub = document.getElementById('tileMsgSub');
    if (msgSub) {
      if (unreadCount > 0) {
        msgSub.textContent = unreadCount + ' unread message' + (unreadCount !== 1 ? 's' : '') + '!';
        msgSub.style.color = '#ff00ff';
      } else {
        msgSub.textContent = 'Chat with friends';
        msgSub.style.color = '';
      }
    }

    // Update wheel tile
    var wheelSub = document.getElementById('tileWheelSub');
    var wheelTile = document.getElementById('tileWheel');
    if (wheelSub && wheelTile) {
      var streak = getConsecutiveKingDays(currentUser);
      if (streak >= 7) {
        wheelSub.textContent = '🔓 Unlocked! Spin now!';
        wheelTile.classList.remove('tile-locked');
      } else {
        wheelSub.textContent = '🔒 ' + streak + '/7 days as King';
        wheelTile.classList.add('tile-locked');
      }
    }
  }

  // ===== SEARCH =====
  function handleFeedSearch() {
    var query = document.getElementById('feedSearchInput').value.trim().toLowerCase();
    var resultsEl = document.getElementById('searchResults');
    var feedListEl = document.getElementById('feedList');

    if (!query) {
      resultsEl.classList.add('hidden');
      resultsEl.innerHTML = '';
      feedListEl.style.display = '';
      return;
    }

    feedListEl.style.display = 'none';
    resultsEl.classList.remove('hidden');

    // Search users
    var allUsernames = Object.keys(cachedUsers);
    // Also include users from videos
    cachedVideos.forEach(function(v) {
      if (allUsernames.indexOf(v.author) === -1) allUsernames.push(v.author);
    });
    var matchingUsers = allUsernames.filter(function(u) {
      return u.toLowerCase().includes(query);
    });

    // Search posts by title
    var matchingPosts = cachedVideos.filter(function(v) {
      return v.title.toLowerCase().includes(query);
    });

    var html = '';

    if (matchingUsers.length > 0) {
      html += '<div class="search-results-section"><h3>Users</h3>';
      // Preload avatars
      preloadAvatars(matchingUsers).then(function() {
        var usersContainer = document.getElementById('searchUsersContainer');
        if (usersContainer) {
          usersContainer.innerHTML = matchingUsers.slice(0, 10).map(function(u) {
            return '<div class="search-user-item" onclick="viewUserProfile(\'' + escapeHtml(u) + '\')">'
              + getAvatarHtml(u) + ' ' + escapeHtml(u)
              + '</div>';
          }).join('');
        }
      });
      html += '<div id="searchUsersContainer">';
      html += matchingUsers.slice(0, 10).map(function(u) {
        return '<div class="search-user-item" onclick="viewUserProfile(\'' + escapeHtml(u) + '\')">'
          + getAvatarHtml(u) + ' ' + escapeHtml(u)
          + '</div>';
      }).join('');
      html += '</div></div>';
    }

    if (matchingPosts.length > 0) {
      html += '<div class="search-results-section"><h3>Posts</h3>';
      var currentUser = getCurrentUser();
      html += matchingPosts.slice(0, 10).map(function(v) {
        var avgRating = v.votes.length > 0
          ? (v.votes.reduce(function(sum, vote) { return sum + vote.rating; }, 0) / v.votes.length).toFixed(1)
          : '-';
        return '<div class="video-card" style="cursor:default;">'
          + '<div class="video-header">'
          + '<div class="video-title">' + escapeHtml(v.title) + '</div>'
          + '<div class="video-author">by ' + getClickableUsername(v.author) + '</div>'
          + '</div>'
          + '<div class="video-embed">' + renderVideoEmbed(v) + '</div>'
          + '<div class="video-stats">'
          + '<span class="avg-rating">⭐ ' + avgRating + '/10</span>'
          + '<span class="vote-count">' + v.votes.length + ' vote' + (v.votes.length !== 1 ? 's' : '') + '</span>'
          + '</div>'
          + '</div>';
      }).join('');
      html += '</div>';
    }

    if (matchingUsers.length === 0 && matchingPosts.length === 0) {
      html = '<div class="search-no-results">No results found for "' + escapeHtml(query) + '"</div>';
    }

    resultsEl.innerHTML = html;
  }

  // ===== MESSAGING SYSTEM =====
  function getConvoId(user1, user2) {
    return [user1, user2].sort().join('_');
  }

  function startConversationsListener() {
    var currentUser = getCurrentUser();
    if (!currentUser || conversationsListener) return;

    conversationsListener = db.ref('conversations').on('value', function(snapshot) {
      cachedConversations = snapshot.val() || {};
      updateUnreadCount();
      // Re-render conversations list if on messages page
      if (!document.getElementById('messagesPage').classList.contains('hidden')) {
        var threadEl = document.getElementById('messageThread');
        if (threadEl.classList.contains('hidden')) {
          renderConversationList();
        }
      }
    });
  }

  function updateUnreadCount() {
    var currentUser = getCurrentUser();
    if (!currentUser) return;
    var count = 0;
    Object.keys(cachedConversations).forEach(function(convoId) {
      var convo = cachedConversations[convoId];
      if (convo.participants && convo.participants[currentUser]) {
        var lastRead = (convo.lastRead && convo.lastRead[currentUser]) || 0;
        if (convo.lastMessageTime > lastRead) count++;
      }
    });
    unreadCount = count;
    updateFeatureTiles();
    var navBtn = document.getElementById('nav-messages');
    if (navBtn) {
      var dot = navBtn.querySelector('.nav-unread-dot');
      if (unreadCount > 0) {
        if (!dot) {
          navBtn.insertAdjacentHTML('beforeend', '<span class="nav-unread-dot"></span>');
        }
      } else {
        if (dot) dot.remove();
      }
    }
  }

  function showConversationList() {
    document.getElementById('messagesContent').classList.remove('hidden');
    document.getElementById('messageThread').classList.add('hidden');
    if (threadMessagesListener && currentThreadConvoId) {
      db.ref('messages/' + currentThreadConvoId).off('value', threadMessagesListener);
      threadMessagesListener = null;
    }
    currentThreadConvoId = null;
    currentThreadUser = null;
    renderConversationList();
  }

  function renderConversationList() {
    var currentUser = getCurrentUser();
    var container = document.getElementById('conversationList');

    // Get conversations this user is part of
    var myConvos = [];
    Object.keys(cachedConversations).forEach(function(convoId) {
      var convo = cachedConversations[convoId];
      if (convo.participants && convo.participants[currentUser]) {
        var otherUser = Object.keys(convo.participants).find(function(u) { return u !== currentUser; });
        if (otherUser) {
          var lastRead = (convo.lastRead && convo.lastRead[currentUser]) || 0;
          myConvos.push({
            id: convoId,
            otherUser: otherUser,
            lastMessage: convo.lastMessage || '',
            lastMessageTime: convo.lastMessageTime || 0,
            unread: convo.lastMessageTime > lastRead
          });
        }
      }
    });

    myConvos.sort(function(a, b) { return b.lastMessageTime - a.lastMessageTime; });

    if (myConvos.length === 0) {
      container.innerHTML = '<div class="no-conversations">No messages yet! Start a conversation with the + New Message button</div>';
      return;
    }

    var users = myConvos.map(function(c) { return c.otherUser; });
    preloadAvatars(users).then(function() {
      container.innerHTML = myConvos.map(function(c) {
        return '<div class="conversation-item' + (c.unread ? ' unread' : '') + '" onclick="openThread(\'' + escapeHtml(c.otherUser) + '\')">'
          + '<div class="convo-avatar">' + getAvatarHtml(c.otherUser) + '</div>'
          + '<div class="convo-info">'
          + '<div class="convo-username">' + escapeHtml(c.otherUser) + getPrizeBadges(c.otherUser) + '</div>'
          + '<div class="convo-preview">' + escapeHtml(c.lastMessage) + '</div>'
          + '</div>'
          + '<div class="convo-time">' + (c.lastMessageTime ? timeAgo(c.lastMessageTime) : '') + '</div>'
          + (c.unread ? '<div class="convo-unread-dot"></div>' : '')
          + '</div>';
      }).join('');
    });
    // Render immediately with cached data
    container.innerHTML = myConvos.map(function(c) {
      return '<div class="conversation-item' + (c.unread ? ' unread' : '') + '" onclick="openThread(\'' + escapeHtml(c.otherUser) + '\')">'
        + '<div class="convo-avatar">' + getAvatarHtml(c.otherUser) + '</div>'
        + '<div class="convo-info">'
        + '<div class="convo-username">' + escapeHtml(c.otherUser) + '</div>'
        + '<div class="convo-preview">' + escapeHtml(c.lastMessage) + '</div>'
        + '</div>'
        + '<div class="convo-time">' + (c.lastMessageTime ? timeAgo(c.lastMessageTime) : '') + '</div>'
        + (c.unread ? '<div class="convo-unread-dot"></div>' : '')
        + '</div>';
    }).join('');
  }

  function openThread(otherUser) {
    var currentUser = getCurrentUser();
    currentThreadUser = otherUser;
    currentThreadConvoId = getConvoId(currentUser, otherUser);

    document.getElementById('messagesContent').classList.add('hidden');
    document.getElementById('messageThread').classList.remove('hidden');

    loadUserProfile(otherUser).then(function() {
      document.getElementById('threadUsername').innerHTML = getAvatarHtml(otherUser) + ' ' + escapeHtml(otherUser);
    });
    document.getElementById('threadUsername').textContent = otherUser;
    document.getElementById('threadMessages').innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Loading messages...</div>';

    // Mark as read
    db.ref('conversations/' + currentThreadConvoId + '/lastRead/' + currentUser).set(Date.now());

    // Listen for messages in this thread
    if (threadMessagesListener) {
      db.ref('messages/' + currentThreadConvoId).off('value', threadMessagesListener);
    }
    threadMessagesListener = db.ref('messages/' + currentThreadConvoId).orderByChild('created').on('value', function(snapshot) {
      var msgs = [];
      snapshot.forEach(function(child) {
        msgs.push({ id: child.key, ...child.val() });
      });
      renderThreadMessages(msgs);
      // Mark as read
      db.ref('conversations/' + currentThreadConvoId + '/lastRead/' + currentUser).set(Date.now());
      updateUnreadCount();
    });

    document.getElementById('msgInput').focus();
  }

  function renderThreadMessages(msgs) {
    var currentUser = getCurrentUser();
    var container = document.getElementById('threadMessages');

    if (msgs.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#666;padding:30px;">No messages yet. Say hi!</div>';
      return;
    }

    container.innerHTML = msgs.map(function(m) {
      var isSent = m.sender === currentUser;
      return '<div class="msg-bubble ' + (isSent ? 'sent' : 'received') + '">'
        + escapeHtml(m.text)
        + '<span class="msg-time">' + timeAgo(m.created) + '</span>'
        + '</div>';
    }).join('');

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }

  function sendMessage() {
    var input = document.getElementById('msgInput');
    var text = input.value.trim();
    if (!text || !currentThreadConvoId || !currentThreadUser) return;

    if (text.length > 500) {
      alert('Message too long! Max 500 characters.');
      return;
    }

    // Content moderation
    var check = checkContentModeration(text);
    if (!check.ok) {
      alert(check.message);
      return;
    }

    var currentUser = getCurrentUser();
    var convoId = currentThreadConvoId;

    // Send message
    var msgRef = db.ref('messages/' + convoId).push();
    msgRef.set({
      sender: currentUser,
      text: text,
      created: Date.now()
    });

    // Update conversation metadata
    db.ref('conversations/' + convoId).update({
      lastMessage: text.substring(0, 50),
      lastMessageTime: Date.now(),
      ['participants/' + currentUser]: true,
      ['participants/' + currentThreadUser]: true,
      ['lastRead/' + currentUser]: Date.now()
    });

    input.value = '';
    input.focus();
  }

  function backToConversations() {
    showConversationList();
  }

  function openNewMessageModal() {
    document.getElementById('newMsgModal').classList.remove('hidden');
    document.getElementById('userPickerSearch').value = '';

    // Load all users
    db.ref('users').once('value').then(function(snap) {
      cachedUsers = snap.val() || {};
      filterUserPicker();
    });
  }

  function closeNewMessageModal() {
    document.getElementById('newMsgModal').classList.add('hidden');
  }

  function filterUserPicker() {
    var query = document.getElementById('userPickerSearch').value.trim().toLowerCase();
    var currentUser = getCurrentUser();
    var container = document.getElementById('userPickerList');

    var users = Object.keys(cachedUsers).filter(function(u) {
      return u !== currentUser && (!query || u.toLowerCase().includes(query));
    });

    preloadAvatars(users.slice(0, 20)).then(function() {
      var listEl = document.getElementById('userPickerList');
      if (!listEl) return;
      listEl.innerHTML = users.slice(0, 20).map(function(u) {
        return '<div class="user-picker-item" onclick="startConversationWith(\'' + escapeHtml(u) + '\')">'
          + getAvatarHtml(u) + ' ' + escapeHtml(u)
          + '</div>';
      }).join('');
    });

    container.innerHTML = users.slice(0, 20).map(function(u) {
      return '<div class="user-picker-item" onclick="startConversationWith(\'' + escapeHtml(u) + '\')">'
        + getAvatarHtml(u) + ' ' + escapeHtml(u)
        + '</div>';
    }).join('');

    if (users.length === 0) {
      container.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">No users found</div>';
    }
  }

  function startConversationWith(otherUser) {
    closeNewMessageModal();
    openThread(otherUser);
  }

  function openDMFromProfile(username) {
    showPage('messages');
    setTimeout(function() { openThread(username); }, 100);
  }

  // ===== PRIZE WHEEL =====
  function getTodayString() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function recordDailyRizzKing() {
    var today = getTodayString();
    // Check if already recorded today
    if (rizzKingHistory[today]) return;

    // Calculate current #1
    var userStats = {};
    cachedVideos.forEach(function(v) {
      if (!userStats[v.author]) userStats[v.author] = { totalRating: 0, totalVotes: 0 };
      v.votes.forEach(function(vote) {
        userStats[v.author].totalRating += vote.rating;
        userStats[v.author].totalVotes++;
      });
    });

    var ranked = Object.entries(userStats)
      .map(function(e) { return { user: e[0], avg: e[1].totalVotes > 0 ? e[1].totalRating / e[1].totalVotes : 0, totalVotes: e[1].totalVotes }; })
      .filter(function(u) { return u.totalVotes > 0; })
      .sort(function(a, b) { return b.avg - a.avg; });

    if (ranked.length > 0) {
      db.ref('rizzKingHistory/' + today).set(ranked[0].user);
    }
  }

  function getConsecutiveKingDays(username) {
    var today = new Date();
    var streak = 0;
    for (var i = 0; i < 30; i++) {
      var d = new Date(today);
      d.setDate(d.getDate() - i);
      var dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      if (rizzKingHistory[dateStr] === username) {
        streak++;
      } else {
        break;
      }
    }
    return streak;
  }

  function renderWheel() {
    var currentUser = getCurrentUser();
    var container = document.getElementById('wheelContent');
    var streak = getConsecutiveKingDays(currentUser);
    var qualified = streak >= 7;
    var freeSpinsCount = cachedFreeSpins[currentUser] || 0;

    // Check if user already spun today
    var today = getTodayString();
    var spunToday = false;
    var myPrizes = userPrizes[currentUser] || {};

    db.ref('wheelSpins/' + currentUser + '/' + today).once('value').then(function(snap) {
      spunToday = snap.exists();
      doRenderWheel(container, currentUser, streak, qualified, spunToday, myPrizes, freeSpinsCount);
    });
  }

  function doRenderWheel(container, currentUser, streak, qualified, spunToday, myPrizes, freeSpinsCount) {
    var html = '';
    var canUseFree = freeSpinsCount > 0;

    // Show current prizes
    var prizeKeys = Object.keys(myPrizes).filter(function(k) { return myPrizes[k]; });
    if (prizeKeys.length > 0) {
      html += '<div style="margin-bottom:20px;"><span style="color:#aaa;">Your prizes: </span>';
      prizeKeys.forEach(function(k) {
        var prize = WHEEL_PRIZES.find(function(p) { return p.key === k; });
        if (prize) html += '<span class="prize-badge" style="font-size:1.3rem;margin:0 4px;" title="' + prize.name + '">' + prize.icon + '</span>';
      });
      html += '</div>';
    }

    // Show free spins count if they have any
    if (canUseFree) {
      html += '<div style="margin-bottom:15px;"><span class="free-spins-badge">🎡 ' + freeSpinsCount + ' FREE SPIN' + (freeSpinsCount !== 1 ? 'S' : '') + '</span></div>';
    }

    if (!qualified && !canUseFree) {
      // Locked state - no free spins either
      html += '<div class="wheel-locked">'
        + '<div class="lock-icon">🔒</div>'
        + '<h3>PRIZE WHEEL LOCKED</h3>'
        + '<p>Be the #1 Rizz King for 7 consecutive days to unlock!</p>'
        + '<p style="color:#aaa;font-size:0.9rem;">Or refer 5 friends for 4 free spins!</p>'
        + '<div class="streak-display">' + streak + '/7 Days</div>'
        + '<div class="streak-bar">';
      for (var i = 0; i < 7; i++) {
        html += '<div class="streak-day' + (i < streak ? ' filled' : '') + '">' + (i < streak ? '✓' : (i + 1)) + '</div>';
      }
      html += '</div>'
        + '<p style="color:#666;font-size:0.85rem;margin-top:10px;">Keep grinding! The top spot is yours! 💪</p>'
        + '</div>';
    } else {
      // Unlocked via streak OR has free spins - show wheel
      if (qualified) {
        html += '<div style="margin-bottom:10px;color:#0f0;font-weight:700;font-size:1.1rem;">🎉 WHEEL UNLOCKED! 7+ day streak! 🎉</div>';
      } else {
        html += '<div style="margin-bottom:10px;color:gold;font-weight:700;font-size:1.1rem;">🎡 Use your free spins! 🎡</div>';
      }

      html += '<div class="wheel-wrapper">'
        + '<div class="wheel-pointer">▼</div>'
        + '<canvas class="wheel-canvas" id="wheelCanvas" width="300" height="300"></canvas>'
        + '</div>';

      if (canUseFree) {
        // Free spins always available
        html += '<button class="spin-btn" id="spinBtn" onclick="spinWheel(true)">🎰 USE FREE SPIN (' + freeSpinsCount + ' left)</button>';
      } else if (spunToday) {
        html += '<div class="wheel-cooldown">You already spun today! Come back tomorrow for another spin.</div>';
      } else {
        html += '<button class="spin-btn" id="spinBtn" onclick="spinWheel(false)">🎰 SPIN THE WHEEL!</button>';
      }

      html += '<div class="wheel-result" id="wheelResult"></div>';
    }

    container.innerHTML = html;

    // Draw the wheel if it exists
    if (qualified || canUseFree) {
      drawWheel(0);
    }
  }

  function drawWheel(rotation) {
    var canvas = document.getElementById('wheelCanvas');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var cx = 150, cy = 150, r = 140;
    var sliceAngle = (2 * Math.PI) / WHEEL_PRIZES.length;

    var colors = ['#ff00ff', '#00ffff', '#ff0080', '#ffff00', '#00ff88', '#8844ff', '#ff4444', '#ff8800'];

    ctx.clearRect(0, 0, 300, 300);
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(rotation);
    ctx.translate(-cx, -cy);

    WHEEL_PRIZES.forEach(function(prize, i) {
      var startAngle = i * sliceAngle - Math.PI / 2;
      var endAngle = startAngle + sliceAngle;

      // Draw slice
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r, startAngle, endAngle);
      ctx.closePath();
      ctx.fillStyle = colors[i % colors.length];
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.3)';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Draw text
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(startAngle + sliceAngle / 2);
      ctx.textAlign = 'center';
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 13px Comic Neue, Comic Sans MS, cursive';
      ctx.shadowColor = 'rgba(0,0,0,0.5)';
      ctx.shadowBlur = 3;
      ctx.fillText(prize.icon, r * 0.65, 5);
      ctx.font = 'bold 10px Comic Neue, Comic Sans MS, cursive';
      ctx.fillText(prize.name, r * 0.65, 18);
      ctx.restore();
    });

    ctx.restore();

    // Center circle
    ctx.beginPath();
    ctx.arc(cx, cy, 20, 0, 2 * Math.PI);
    ctx.fillStyle = '#1a0033';
    ctx.fill();
    ctx.strokeStyle = 'gold';
    ctx.lineWidth = 3;
    ctx.stroke();
  }

  function spinWheel(useFree) {
    if (wheelSpinning) return;
    wheelSpinning = true;

    var btn = document.getElementById('spinBtn');
    if (btn) btn.disabled = true;

    var currentUser = getCurrentUser();
    var today = getTodayString();

    // Pick a random prize
    var prizeIndex = Math.floor(Math.random() * WHEEL_PRIZES.length);
    var prize = WHEEL_PRIZES[prizeIndex];

    // Calculate rotation
    var sliceAngle = 360 / WHEEL_PRIZES.length;
    var targetAngle = 360 - (prizeIndex * sliceAngle + sliceAngle / 2);
    var totalRotation = 360 * 5 + targetAngle;

    var startTime = Date.now();
    var duration = 4000;
    var startRotation = 0;

    function animate() {
      var elapsed = Date.now() - startTime;
      var progress = Math.min(elapsed / duration, 1);
      var eased = 1 - Math.pow(1 - progress, 3);
      var currentRotation = (startRotation + totalRotation * eased) * Math.PI / 180;

      drawWheel(currentRotation);

      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        // Spin complete!
        wheelSpinning = false;

        // Record prize
        db.ref('userPrizes/' + currentUser + '/' + prize.key).set(true);

        if (useFree) {
          // Deduct a free spin
          var remaining = (cachedFreeSpins[currentUser] || 1) - 1;
          db.ref('freeSpins/' + currentUser).set(Math.max(0, remaining));
        } else {
          // Record as today's spin
          db.ref('wheelSpins/' + currentUser + '/' + today).set(prize.key);
        }

        var resultEl = document.getElementById('wheelResult');
        if (resultEl) {
          resultEl.innerHTML = '🎉 You won: ' + prize.icon + ' ' + prize.name + '! 🎉';
        }

        // Re-render wheel after a moment to update free spins count / button state
        setTimeout(function() { renderWheel(); }, 1500);
      }
    }

    requestAnimationFrame(animate);
  }

  // ===== 5-REFERRAL REWARD =====
  function getReferralCount(username) {
    var refs = cachedReferrals[username];
    if (!refs) return 0;
    return Object.keys(refs).length;
  }

  function checkSubReward() {
    var currentUser = getCurrentUser();
    if (!currentUser || rewardPopupShown) return;
    if (subRewardClaimed[currentUser]) return;
    var refCount = getReferralCount(currentUser);
    if (refCount >= 5) {
      rewardPopupShown = true;
      showRewardPopup();
    }
  }

  function showRewardPopup() {
    var existing = document.getElementById('rewardPopup');
    if (existing) existing.remove();

    var popup = document.createElement('div');
    popup.id = 'rewardPopup';
    popup.className = 'reward-popup';
    popup.innerHTML = '<div class="reward-box">'
      + '<div class="reward-icon">🎉🎡🎉</div>'
      + '<h2>5 FRIENDS REFERRED!</h2>'
      + '<p>5 people said YOU told them about vote.rizz!</p>'
      + '<div class="reward-prize">🎡 4 FREE SPINS 🎡</div>'
      + '<p style="color:#aaa;font-size:0.9rem;">Use them on the Prize Wheel anytime!</p>'
      + '<button class="reward-claim-btn" onclick="claimSubReward()">CLAIM REWARD! 🔥</button>'
      + '</div>';
    document.body.appendChild(popup);
  }

  function renderSubRewardBanner() {
    var banner = document.getElementById('subRewardBanner');
    if (!banner) return;
    var currentUser = getCurrentUser();
    if (!currentUser) { banner.innerHTML = ''; return; }

    var refCount = getReferralCount(currentUser);
    var claimed = subRewardClaimed[currentUser];
    var freeCount = cachedFreeSpins[currentUser] || 0;

    if (claimed) {
      banner.innerHTML = '<div class="sub-reward-banner claimed">'
        + '<div class="srb-icon">✅</div>'
        + '<div class="srb-info">'
        + '<div class="srb-title">REFERRAL REWARD CLAIMED!</div>'
        + '<div class="srb-desc">You earned 4 free wheel spins.' + (freeCount > 0 ? ' You have ' + freeCount + ' left!' : ' All used up!') + '</div>'
        + '</div>'
        + '</div>';
    } else {
      var progress = Math.min(refCount, 5);
      var dotsHtml = '';
      for (var i = 0; i < 5; i++) {
        dotsHtml += '<div class="srb-dot' + (i < progress ? ' filled' : '') + '">' + (i < progress ? '✓' : (i + 1)) + '</div>';
      }
      banner.innerHTML = '<div class="sub-reward-banner">'
        + '<div class="srb-icon">🤝</div>'
        + '<div class="srb-info">'
        + '<div class="srb-title">REFER 5 FRIENDS = 4 FREE SPINS!</div>'
        + '<div class="srb-desc">' + progress + '/5 friends referred — '
        + (progress >= 5 ? 'You did it! Check the popup!' : (5 - progress) + ' more to go!')
        + '</div>'
        + '<div class="srb-progress">' + dotsHtml + '</div>'
        + '</div>'
        + '</div>';
    }
  }

  function claimSubReward() {
    var currentUser = getCurrentUser();
    if (!currentUser) return;

    var currentFree = cachedFreeSpins[currentUser] || 0;
    db.ref('freeSpins/' + currentUser).set(currentFree + 4);
    db.ref('subRewardClaimed/' + currentUser).set(true);

    // Play confetti celebration!
    spawnConfetti();

    var popup = document.getElementById('rewardPopup');
    if (popup) {
      setTimeout(function() { popup.remove(); }, 2000);
    }
  }

  // ===== CONFETTI =====
  function spawnConfetti() {
    var container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);
    var colors = ['#ff00ff', '#00ffff', '#ffff00', '#ff0080', '#00ff88', '#ff8800', '#8800ff', 'gold', '#ff4444', '#44ff44'];
    for (var i = 0; i < 40; i++) {
      var piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.style.left = (Math.random() * 100) + '%';
      piece.style.top = (40 + Math.random() * 20) + '%';
      piece.style.setProperty('--x', (Math.random() * 200 - 100) + 'px');
      piece.style.background = colors[Math.floor(Math.random() * colors.length)];
      piece.style.animationDelay = (Math.random() * 0.5) + 's';
      piece.style.width = (6 + Math.random() * 8) + 'px';
      piece.style.height = (6 + Math.random() * 8) + 'px';
      piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
      container.appendChild(piece);
    }
    setTimeout(function() { container.remove(); }, 3500);
  }

  // ===== 100-USER GOAL =====
  function updateGoalTracker() {
    var count = Object.keys(cachedUsers).length;
    var goalCount = document.getElementById('goalCount');
    var goalBarFill = document.getElementById('goalBarFill');
    var goalBarText = document.getElementById('goalBarText');
    var goalMessage = document.getElementById('goalMessage');
    if (!goalCount) return;

    goalCount.textContent = count;
    var pct = Math.min(count / 100 * 100, 100);
    goalBarFill.style.width = pct + '%';
    goalBarText.textContent = Math.round(pct) + '%';

    if (count >= 100) {
      goalMessage.innerHTML = '<div class="goal-complete">🎉 WE DID IT! 100 USERS! 🎉</div>';
    } else {
      goalMessage.innerHTML = '<div style="color:#888;font-size:0.8rem;margin-top:4px;">' + (100 - count) + ' more to go!</div>';
    }
  }

  // ===== BIRTHDAY SYSTEM =====
  function checkBirthdays() {
    var today = new Date();
    var todayStr = (today.getMonth() + 1 < 10 ? '0' : '') + (today.getMonth() + 1) + '-' + (today.getDate() < 10 ? '0' : '') + today.getDate();
    var birthdayUsers = [];

    Object.keys(cachedUsers).forEach(function(username) {
      var user = cachedUsers[username];
      if (user && user.birthday === todayStr) {
        birthdayUsers.push(username);
      }
    });

    var bannerEl = document.getElementById('birthdayBannerFeed');
    if (!bannerEl) return;

    if (birthdayUsers.length > 0) {
      var names = birthdayUsers.map(function(u) { return escapeHtml(u); }).join(', ');
      bannerEl.innerHTML = '<div class="birthday-banner">'
        + '<div class="birthday-title">🎂 Happy Birthday ' + names + '! 🎂</div>'
        + '</div>';
      // Spawn birthday emojis
      spawnBirthdayEmojis();
    } else {
      bannerEl.innerHTML = '';
    }
  }

  function spawnBirthdayEmojis() {
    var existing = document.querySelector('.birthday-emojis');
    if (existing) existing.remove();

    var container = document.createElement('div');
    container.className = 'birthday-emojis';
    document.body.appendChild(container);
    var emojis = ['🎂', '🎉', '🎈', '🥳', '🎁', '🎊', '🍰', '🧁'];
    for (var i = 0; i < 20; i++) {
      var emoji = document.createElement('div');
      emoji.className = 'birthday-emoji';
      emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      emoji.style.left = (Math.random() * 100) + '%';
      emoji.style.animationDelay = (Math.random() * 3) + 's';
      emoji.style.fontSize = (1.5 + Math.random() * 1.5) + 'rem';
      container.appendChild(emoji);
    }
    setTimeout(function() { container.remove(); }, 7000);
  }

  // ===== LIVESTREAM SYSTEM =====
  var currentStream = null; // { id, peerConnection, mediaStream }
  var livestreamListener = null;

  function renderLivePage() {
    var statusEl = document.getElementById('liveStatus');
    var listEl = document.getElementById('liveStreamList');
    var formEl = document.getElementById('startStreamForm');
    var viewerEl = document.getElementById('liveViewerContainer');
    viewerEl.classList.add('hidden');
    formEl.style.display = '';
    statusEl.style.display = '';
    listEl.innerHTML = '';

    // Listen for active streams
    if (livestreamListener) db.ref('livestreams').off('value', livestreamListener);
    livestreamListener = db.ref('livestreams').on('value', function(snap) {
      var streams = snap.val() || {};
      var activeStreams = [];
      Object.keys(streams).forEach(function(id) {
        if (streams[id].active) {
          activeStreams.push({ id: id, data: streams[id] });
        }
      });

      if (activeStreams.length === 0) {
        statusEl.textContent = 'No one is live right now. Be the first!';
        statusEl.style.display = '';
        listEl.innerHTML = '';
        // Show start form only if no one is live (1 at a time)
        formEl.style.display = '';
      } else {
        statusEl.style.display = 'none';
        // Hide start form if someone is already live
        var currentUser = getCurrentUser();
        var isStreamer = activeStreams.some(function(s) { return s.data.streamer === currentUser; });
        formEl.style.display = isStreamer ? 'none' : 'none'; // hide for everyone when a stream is active

        listEl.innerHTML = activeStreams.map(function(s) {
          return '<div class="live-stream-card" onclick="watchStream(\'' + s.id + '\')">'
            + '<div><span class="live-dot"></span><span class="live-stream-title">' + escapeHtml(s.data.title || 'Untitled Stream') + '</span></div>'
            + '<div class="live-stream-info">by ' + escapeHtml(s.data.streamer) + ' · ' + (s.data.viewerCount || 0) + ' watching</div>'
            + '</div>';
        }).join('');
      }
    });
  }

  function startLiveStream() {
    var titleInput = document.getElementById('streamTitleInput');
    var title = titleInput.value.trim();
    if (!title) { alert('Give your stream a title!'); return; }

    var modCheck = checkContentModeration(title);
    if (!modCheck.ok) { alert(modCheck.message); return; }

    // Check if anyone is already streaming (only 1 at a time)
    db.ref('livestreams').once('value').then(function(snap) {
      var streams = snap.val() || {};
      var hasActive = Object.keys(streams).some(function(id) { return streams[id].active; });
      if (hasActive) {
        alert('Someone is already live! Only 1 stream at a time.');
        return;
      }

      // Request screen share + mic
      navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }).then(function(screenStream) {
        // Try to get mic audio too
        navigator.mediaDevices.getUserMedia({ audio: true }).then(function(micStream) {
          // Combine screen video + mic audio
          var combined = new MediaStream();
          screenStream.getVideoTracks().forEach(function(t) { combined.addTrack(t); });
          micStream.getAudioTracks().forEach(function(t) { combined.addTrack(t); });
          setupStream(combined, title, screenStream, micStream);
        }).catch(function() {
          // No mic, just screen
          setupStream(screenStream, title, screenStream, null);
        });
      }).catch(function(err) {
        alert('Screen sharing was cancelled or not supported.');
        console.error(err);
      });
    });
  }

  function setupStream(mediaStream, title, screenStream, micStream) {
    var currentUser = getCurrentUser();
    var streamId = currentUser + '_' + Date.now();

    db.ref('livestreams/' + streamId).set({
      streamer: currentUser,
      title: title,
      active: true,
      started: Date.now(),
      viewerCount: 0,
      reports: 0
    });

    // Show own stream
    var videoEl = document.getElementById('liveVideo');
    videoEl.srcObject = mediaStream;
    document.getElementById('liveViewerContainer').classList.remove('hidden');
    document.getElementById('startStreamForm').style.display = 'none';
    document.getElementById('liveStatus').style.display = 'none';
    document.getElementById('liveStreamList').innerHTML = '';
    document.getElementById('liveViewerCount').textContent = '🔴 YOU ARE LIVE';
    document.getElementById('liveControls').innerHTML = '<button class="live-btn live-btn-stop" onclick="stopStream()">STOP STREAM</button>';

    currentStream = { id: streamId, mediaStream: mediaStream, screenStream: screenStream, micStream: micStream };

    // Auto-end after 30 minutes
    setTimeout(function() {
      if (currentStream && currentStream.id === streamId) {
        stopStream();
        alert('Stream ended! 30 minute limit reached.');
      }
    }, 30 * 60 * 1000);

    // End stream if screen share stops
    mediaStream.getVideoTracks()[0].onended = function() {
      stopStream();
    };
  }

  function stopStream() {
    if (!currentStream) return;
    // Stop all tracks
    if (currentStream.mediaStream) currentStream.mediaStream.getTracks().forEach(function(t) { t.stop(); });
    if (currentStream.screenStream) currentStream.screenStream.getTracks().forEach(function(t) { t.stop(); });
    if (currentStream.micStream) currentStream.micStream.getTracks().forEach(function(t) { t.stop(); });

    db.ref('livestreams/' + currentStream.id + '/active').set(false);
    currentStream = null;

    document.getElementById('liveVideo').srcObject = null;
    document.getElementById('liveViewerContainer').classList.add('hidden');
    renderLivePage();
  }

  function watchStream(streamId) {
    // For now, show a simplified viewer (full WebRTC P2P requires TURN servers)
    // Instead, show stream info and let viewers know they're watching
    db.ref('livestreams/' + streamId).once('value').then(function(snap) {
      var data = snap.val();
      if (!data || !data.active) {
        alert('This stream has ended!');
        return;
      }

      var currentUser = getCurrentUser();
      if (data.streamer === currentUser) return; // Don't watch your own stream

      // Increment viewer count
      db.ref('livestreams/' + streamId + '/viewerCount').transaction(function(count) {
        return (count || 0) + 1;
      });

      document.getElementById('liveStreamList').innerHTML = '';
      document.getElementById('startStreamForm').style.display = 'none';
      document.getElementById('liveStatus').style.display = 'none';
      document.getElementById('liveViewerContainer').classList.remove('hidden');
      document.getElementById('liveViewerCount').innerHTML = '<span class="live-dot"></span> LIVE · ' + escapeHtml(data.title) + ' · by ' + escapeHtml(data.streamer);
      document.getElementById('liveVideo').style.display = 'none';

      // Show watching message + controls
      var viewerArea = document.querySelector('.live-viewer-area');
      viewerArea.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:200px;color:#888;font-size:1.1rem;padding:20px;text-align:center;">'
        + '📺 Watching ' + escapeHtml(data.streamer) + '\'s screen share...<br>🔊 Listen for their voice!'
        + '</div>';

      document.getElementById('liveControls').innerHTML =
        '<button class="live-btn live-btn-report" onclick="reportStream(\'' + streamId + '\')">🚩 Report</button>'
        + '<button class="live-btn live-btn-back" onclick="leaveLiveView(\'' + streamId + '\')">← Back</button>';
    });
  }

  function reportStream(streamId) {
    if (confirm('Report this stream as inappropriate?')) {
      db.ref('livestreams/' + streamId + '/reports').transaction(function(count) {
        return (count || 0) + 1;
      }).then(function() {
        db.ref('livestreams/' + streamId + '/reports').once('value').then(function(snap) {
          var reports = snap.val() || 0;
          if (reports >= 3) {
            db.ref('livestreams/' + streamId + '/active').set(false);
            alert('Stream shut down due to reports.');
            leaveLiveView(streamId);
          } else {
            alert('Report submitted. (' + reports + '/3)');
          }
        });
      });
    }
  }

  function leaveLiveView(streamId) {
    // Decrement viewer count
    db.ref('livestreams/' + streamId + '/viewerCount').transaction(function(count) {
      return Math.max((count || 0) - 1, 0);
    });
    document.getElementById('liveViewerContainer').classList.add('hidden');
    document.getElementById('liveVideo').style.display = '';
    renderLivePage();
  }

  // ===== RIZZ KING DAILY REWARD =====
  function checkDailyKingReward() {
    var currentUser = getCurrentUser();
    if (!currentUser) return;

    var today = getTodayString();
    var kingToday = rizzKingHistory[today];
    if (!kingToday || kingToday !== currentUser) return;

    // Check if already claimed today's king reward
    var claimKey = 'vrizz_king_reward_' + today;
    if (sessionStorage.getItem(claimKey)) return;

    // Check if they were king yesterday too (consecutive)
    var yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    var yStr = yesterday.getFullYear() + '-' + ((yesterday.getMonth() + 1) < 10 ? '0' : '') + (yesterday.getMonth() + 1) + '-' + (yesterday.getDate() < 10 ? '0' : '') + yesterday.getDate();
    var kingYesterday = rizzKingHistory[yStr];

    if (kingYesterday === currentUser) {
      // Consecutive king! Give free spin + random animation
      sessionStorage.setItem(claimKey, 'true');
      var currentFree = cachedFreeSpins[currentUser] || 0;
      db.ref('freeSpins/' + currentUser).set(currentFree + 1);
      showKingAnimation();
    }
  }

  function showKingAnimation() {
    var animations = [
      function() { spawnConfetti(); },
      function() { spawnBirthdayEmojis(); },
      function() {
        // Golden flash
        var flash = document.createElement('div');
        flash.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,215,0,0.3);z-index:1002;pointer-events:none;animation:rewardFadeIn 0.3s ease reverse forwards;';
        document.body.appendChild(flash);
        setTimeout(function() { flash.remove(); }, 800);
      },
      function() {
        // Crown rain
        var container = document.createElement('div');
        container.className = 'birthday-emojis';
        document.body.appendChild(container);
        for (var i = 0; i < 15; i++) {
          var e = document.createElement('div');
          e.className = 'birthday-emoji';
          e.textContent = '👑';
          e.style.left = (Math.random() * 100) + '%';
          e.style.animationDelay = (Math.random() * 2) + 's';
          container.appendChild(e);
        }
        setTimeout(function() { container.remove(); }, 5000);
      }
    ];
    var pick = animations[Math.floor(Math.random() * animations.length)];
    pick();

    // Show toast
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,gold,#ff8c00);color:#0f0024;padding:12px 24px;border-radius:25px;font-family:Bangers,cursive;font-size:1.1rem;z-index:1003;text-align:center;box-shadow:0 4px 20px rgba(255,215,0,0.5);';
    toast.textContent = '👑 Still the King! +1 Free Spin!';
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 3000);
  }

  // ===== INIT =====
  // If user was previously logged in, verify they still exist in Firebase and re-enter
  (function() {
    const savedUser = getCurrentUser();
    if (savedUser) {
      db.ref('users/' + savedUser).once('value').then(function(snapshot) {
        if (snapshot.exists()) {
          enterApp();
        } else {
          clearCurrentUser();
        }
      }).catch(function() {
        // Firebase not configured yet — just show login
        clearCurrentUser();
      });
    }
  })();
</script>
</body>
</html>
